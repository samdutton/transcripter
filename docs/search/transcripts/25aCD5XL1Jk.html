<section>
<p><span data-start="0" data-end="3.444">[MUSIC PLAYING]</span> </p>
</section>

<section>
<p><span data-start="7.186" data-end="8.31"><span class="speaker">Phil Walton</span>: Hey, everyone.</span> <span data-start="8.31" data-end="9.14">My name is Philip Walton.</span> <span data-start="9.14" data-end="11.681">I'm an engineer on the Chrome team working on web performance</span> <span data-start="11.681" data-end="13.31">and Service Worker tooling.</span> </p>
</section>

<section>
<p><span data-start="13.31" data-end="14.518"><span class="speaker">Ewa Gasperowicz</span>: And I'm Ewa.</span> <span data-start="14.518" data-end="16.36">I'm also an engineer on the Chrome team.</span> <span data-start="16.36" data-end="19.82">Today we're going to talk about Service Worker from the speed</span> <span data-start="19.82" data-end="22.13">and resilience perspective.</span> </p>
<p><span data-start="22.13" data-end="24.86">We'll look into how our decisions regarding Service</span> <span data-start="24.86" data-end="27.47">Worker implementation can influence,</span> <span data-start="27.47" data-end="31.13">both positively and negatively, our site's performance.</span> <span data-start="31.13" data-end="32.93">And we hope that by the end of this talk,</span> <span data-start="32.93" data-end="35.15">you'll have a really good understanding</span> <span data-start="35.15" data-end="38.69">of all the trade-offs involved in using this more and more</span> <span data-start="38.69" data-end="40.185">mainstream technology.</span> </p>
</section>

<section>
<p><span data-start="40.185" data-end="41.81"><span class="speaker">Phil Walton</span>: So Ewa, I noticed you said</span> <span data-start="41.81" data-end="43.06">Service Worker was mainstream.</span> <span data-start="43.06" data-end="44.139">What makes you say that?</span> </p>
</section>

<section>
<p><span data-start="44.139" data-end="45.68"><span class="speaker">Ewa Gasperowicz</span>: Well, Service Worker</span> <span data-start="45.68" data-end="48.38">is now supported in all modern browsers, which</span> <span data-start="48.38" data-end="50.63">means you can move from treating this</span> <span data-start="50.63" data-end="53.51">as a pure progressive enhancement</span> <span data-start="53.51" data-end="57.05">and treat it as a core part of your site's architecture.</span> </p>
<p><span data-start="57.05" data-end="59.39">Service Worker can do many things, but in this talk</span> <span data-start="59.39" data-end="63.96">we'll focus especially on its caching capabilities.</span> <span data-start="63.96" data-end="66.9">Often when we think about Service Worker and caching,</span> <span data-start="66.9" data-end="70.83">we usually associate it with providing offline support.</span> <span data-start="70.83" data-end="73.92">After all, one of the main achievements of Service Worker</span> <span data-start="73.92" data-end="77.73">was that we finally could get rid of the offline downosaur</span> <span data-start="77.73" data-end="82.17">and send him to the well-deserved retirement.</span> <span data-start="82.17" data-end="85.38">But apart from that, Service Worker</span> <span data-start="85.38" data-end="88.11">can also be a great tool for improving</span> <span data-start="88.11" data-end="91.17">the performance of your online site,</span> <span data-start="91.17" data-end="93.63">especially for your returning users.</span> </p>
<p><span data-start="93.63" data-end="96.6">When used right, it can give you a serious boost in terms</span> <span data-start="96.6" data-end="98.997">of speed on the repeated visit.</span> </p>
</section>

<section>
<p><span data-start="98.997" data-end="100.08"><span class="speaker">Phil Walton</span>: That's right.</span> <span data-start="100.08" data-end="101.913">And on the other hand, when used incorrectly</span> <span data-start="101.913" data-end="104.28">or without proper analysis, it can actually</span> <span data-start="104.28" data-end="106.56">hamper a site's performance, or even</span> <span data-start="106.56" data-end="109.47">derail the whole experience altogether.</span> <span data-start="109.47" data-end="111.3">So as developers, it's critical that we</span> <span data-start="111.3" data-end="113.07">understand how Service Worker affects</span> <span data-start="113.07" data-end="114.51">the performance of our site.</span> <span data-start="114.51" data-end="117.211">As with any technology, there are both costs and benefits.</span> </p>
<p><span data-start="117.211" data-end="118.71">And we want to maximize the benefits</span> <span data-start="118.71" data-end="120.939">while minimizing the costs.</span> </p>
</section>

<section>
<p><span data-start="120.939" data-end="122.73"><span class="speaker">Ewa Gasperowicz</span>: Well, using Service Worker</span> <span data-start="122.73" data-end="126.04">brings a lot of benefits in terms of performance.</span> <span data-start="126.04" data-end="129.75">In many cases it allows you to overcome the network latency</span> <span data-start="129.75" data-end="130.35">entirely.</span> </p>
<p><span data-start="130.35" data-end="132.27">For example, if you cache your entire app,</span> <span data-start="132.27" data-end="136.1">you don't need to go to the network anymore.</span> <span data-start="136.1" data-end="138.82">Also, if you have some cached content,</span> <span data-start="138.82" data-end="140.68">you can show it immediately, even</span> <span data-start="140.68" data-end="144.22">if a bit stale, and look for the updates in the background</span> <span data-start="144.22" data-end="145.03">at the same time.</span> <span data-start="147.74" data-end="151.59">It can also make your average requests smaller on average.</span> <span data-start="151.59" data-end="153.53">For example, in the app show model</span> <span data-start="153.53" data-end="156.65">where you're fetching just partial part of your page</span> <span data-start="156.65" data-end="160.59">rather than the full HTML each time.</span> <span data-start="160.59" data-end="163.29">Finally, there are some more subtle benefits.</span> <span data-start="163.29" data-end="165.21">For example, we know that JavaScripts</span> <span data-start="165.21" data-end="169.75">need to be parsed, compiled, and executed before it can be used.</span> </p>
<p><span data-start="169.75" data-end="171.13">This can take time.</span> <span data-start="171.13" data-end="174.66">So engines like V8 use some heuristics</span> <span data-start="174.66" data-end="176.99">to see if they can actually store the bytecode</span> <span data-start="176.99" data-end="179.94">from these phases to be used on repeated visits</span> <span data-start="179.94" data-end="182.14">to avoid this cost.</span> <span data-start="182.14" data-end="185.01">Now in Service Worker, the chances of a repeated visit</span> <span data-start="185.01" data-end="186.22">are pretty high.</span> <span data-start="186.22" data-end="189.12">So it can opt into that optimization</span> <span data-start="189.12" data-end="191.16">automatically for you.</span> <span data-start="191.16" data-end="194.47">This means that it stores the script as bytecode</span> <span data-start="194.47" data-end="199.02">by default, making the repeated visits faster.</span> </p>
<p><span data-start="199.02" data-end="201.48">All these are really good performance reasons</span> <span data-start="201.48" data-end="204.16">to implement Service Worker on your page.</span> <span data-start="204.16" data-end="205.842">But it's not for free.</span> <span data-start="205.842" data-end="207.3">Phil, what are the costs of running</span> <span data-start="207.3" data-end="208.99">Service Worker on your page?</span> </p>
</section>

<section>
<p><span data-start="208.99" data-end="211.35"><span class="speaker">Phil Walton</span>: Yeah, so the first and arguably most often</span> <span data-start="211.35" data-end="213.079">overlooked cost of Service Worker</span> <span data-start="213.079" data-end="215.37">is that it can take time for the Service Worker process</span> <span data-start="215.37" data-end="217.681">to start up if it's not already running.</span> </p>
<p><span data-start="217.681" data-end="219.18">And this can happen if a user hasn't</span> <span data-start="219.18" data-end="221.82">visited your site in a while.</span> <span data-start="221.82" data-end="223.44">Let me show you what I mean.</span> <span data-start="223.44" data-end="225.57">Consider a basic network first strategy</span> <span data-start="225.57" data-end="228.03">in which the service worker just forwards the request</span> <span data-start="228.03" data-end="229.71">from the web app onto the network</span> <span data-start="229.71" data-end="231.9">and doesn't touch the cache at all.</span> </p>
<p><span data-start="231.9" data-end="234.24">Since this web app is running a service worker,</span> <span data-start="234.24" data-end="236.94">every request then has to go through that service worker,</span> <span data-start="236.94" data-end="239.19">and if the service worker process isn't currently</span> <span data-start="239.19" data-end="242.25">running, the web app has to wait for the browser to spin it up</span> <span data-start="242.25" data-end="244.927">before it can make any request.</span> <span data-start="244.927" data-end="246.51">So let's take a look at the total time</span> <span data-start="246.51" data-end="249.75">it takes to make a request in various scenarios.</span> <span data-start="249.75" data-end="252.36">In the case where the web app isn't using Service Worker,</span> <span data-start="252.36" data-end="255.42">the total time is just the total of network latency.</span> <span data-start="255.42" data-end="257.91">In the case where the web app is using Service Worker</span> <span data-start="257.91" data-end="260.321">and that service worker is already running,</span> <span data-start="260.321" data-end="261.779">there is a little bit of extra cost</span> <span data-start="261.779" data-end="263.52">because it has to go through the service worker — </span> <span data-start="263.52" data-end="265.08">the request has to go through the service worker — </span> <span data-start="265.08" data-end="266.9">but that cost isn't usually too high.</span> <span data-start="266.9" data-end="269.4">However, in the case where the service worker is not running</span> <span data-start="269.4" data-end="271.47">and needs to boot up, that startup time</span> <span data-start="271.47" data-end="273.907">can really delay the response.</span> </p>
<p></p>
</section>

<section>
<p><span data-start="273.907" data-end="275.49"><span class="speaker">Ewa Gasperowicz</span>: So in cases like this</span> <span data-start="275.49" data-end="277.156">where the service worker is actually not</span> <span data-start="277.156" data-end="279.78">running on the page, how long does it usually</span> <span data-start="279.78" data-end="280.447">take to boot up?</span> </p>
</section>

<section>
<p><span data-start="280.447" data-end="282.071"><span class="speaker">Phil Walton</span>: So that's a good question.</span> <span data-start="282.071" data-end="284.984">And the honest answer is it depends on the user's device,</span> <span data-start="284.984" data-end="286.65">but fortunately there is an easy way you</span> <span data-start="286.65" data-end="289">can measure this cost yourself.</span> <span data-start="289" data-end="290.97">So this code here uses the performance timeline</span> <span data-start="290.97" data-end="293.132">to get performance data for a particular URL.</span> </p>
<p><span data-start="293.132" data-end="295.59">If the request for the URL went through the service worker,</span> <span data-start="295.59" data-end="297.9">then the worker start property on the performance entry</span> <span data-start="297.9" data-end="299.775">will mark the moment right before the service</span> <span data-start="299.775" data-end="300.93">worker was run.</span> <span data-start="300.93" data-end="302.43">And the request start property will</span> <span data-start="302.43" data-end="304.23">mark the moment the service worker received</span> <span data-start="304.23" data-end="305.134">the fetch event.</span> <span data-start="305.134" data-end="307.05">So the difference between these two timestamps</span> <span data-start="307.05" data-end="310.351">is the total time it took for the worker to start up.</span> <span data-start="310.351" data-end="312.6">And if the service worker process was already running,</span> <span data-start="312.6" data-end="315.299">this time will be usually zero or close to zero.</span> </p>
<p><span data-start="315.299" data-end="317.34">And so I actually measure service worker start up</span> <span data-start="317.34" data-end="319.95">time on my website, philipwalton.com, and here's</span> <span data-start="319.95" data-end="322.105">what I found when looking at my own data.</span> <span data-start="322.105" data-end="324.48">When users visits my site for the first time —  or, sorry,</span> <span data-start="324.48" data-end="326.99">for the first time after installing the service worker — </span> <span data-start="326.99" data-end="329.87">it's already running only about 25% of the time.</span> <span data-start="329.87" data-end="332.85">That means 75% of the time the service worker is not running</span> <span data-start="332.85" data-end="334.98">and needs to take some time to start up.</span> <span data-start="334.98" data-end="338.01">For those cases, I found that on desktop it's</span> <span data-start="338.01" data-end="340.95">usually between 20 and 100 milliseconds to start up,</span> <span data-start="340.95" data-end="344.01">but on mobile it can be more like 100 to 500 milliseconds,</span> <span data-start="344.01" data-end="346.17">and at the 95th percentile, sometimes it's</span> <span data-start="346.17" data-end="347.62">more than a second.</span> <span data-start="347.62" data-end="349.95">So let me reiterate, these are stats from my website.</span> <span data-start="349.95" data-end="351.75">The numbers you see might be different,</span> <span data-start="351.75" data-end="353.88">but this should give you a general idea</span> <span data-start="353.88" data-end="356.011">of what's possible.</span> </p>
<p><span data-start="356.011" data-end="358.51">Another cost of using Service Worker is that the cache reads</span> <span data-start="358.51" data-end="360.14">aren't always instant.</span> <span data-start="360.14" data-end="361.93">And this affects any caching strategy</span> <span data-start="361.93" data-end="364.013">where the service worker has to wait for the cache</span> <span data-start="364.013" data-end="367.559">to either miss or error before it can go to the network.</span> <span data-start="367.559" data-end="369.35">We saw before that a network first strategy</span> <span data-start="369.35" data-end="372.157">can be slow when you're not using Service Worker at all.</span> <span data-start="372.157" data-end="374.24">But what about strategies that use cache, or start</span> <span data-start="374.24" data-end="375.519">with the cache, anyway?</span> </p>
<p><span data-start="375.519" data-end="377.06">A cache first strategy will initially</span> <span data-start="377.06" data-end="380.06">look for a response in the cache, and if one is found</span> <span data-start="380.06" data-end="380.924">it'll be used.</span> <span data-start="380.924" data-end="383.09">But if it's not found or there's a timeout or error,</span> <span data-start="383.09" data-end="385.799">like I mentioned, it will fall back to the network.</span> <span data-start="385.799" data-end="388.09">So here's how the performance of cache first strategies</span> <span data-start="388.09" data-end="390.45">break down in different scenarios.</span> <span data-start="390.45" data-end="391.91">The most common case is going to be</span> <span data-start="391.91" data-end="393.86">the one at the top, which is very fast when</span> <span data-start="393.86" data-end="395.98">there's a cache hit.</span> </p>
<p><span data-start="395.98" data-end="397.84">But this is not the only possibility.</span> <span data-start="397.84" data-end="399.67">There could also be a cache miss,</span> <span data-start="399.67" data-end="402.617">there could be a slow cache, you could have a timeout — </span> <span data-start="402.617" data-end="404.2">remember, there's also the possibility</span> <span data-start="404.2" data-end="405.658">of the service worker isn't running</span> <span data-start="405.658" data-end="407.84">and so then that could delay it as well.</span> </p>
<p><span data-start="407.84" data-end="411.17">All of these bad cases could happen at the same time.</span> <span data-start="411.17" data-end="413.41">So while it's definitely possible to have a cache</span> <span data-start="413.41" data-end="416.08">first strategy that's faster than not using a service</span> <span data-start="416.08" data-end="418.42">worker, look at how many of these examples</span> <span data-start="418.42" data-end="419.299">end up being slower.</span> </p>
</section>

<section>
<p><span data-start="419.299" data-end="420.34"><span class="speaker">Ewa Gasperowicz</span>: So Phil.</span> </p>
<p><span data-start="420.34" data-end="424.3">I'm wondering how likely is it that the slow cases actually</span> <span data-start="424.3" data-end="425.11">occur.</span> <span data-start="425.11" data-end="426.25">Is it measurable somehow?</span> </p>
</section>

<section>
<p><span data-start="426.25" data-end="427"><span class="speaker">Phil Walton</span>: Yeah.</span> <span data-start="427" data-end="428.92">So this is also measurable.</span> <span data-start="428.92" data-end="431.95">It's a little bit trickier than the last example I was showing.</span> <span data-start="431.95" data-end="435.7">So this, the same way, uses the performance timeline,</span> <span data-start="435.7" data-end="439.12">and you can look at the entries transfer size property.</span> <span data-start="439.12" data-end="440.737">If the transfer size is zero, that</span> <span data-start="440.737" data-end="442.57">means the request either came from the cache</span> <span data-start="442.57" data-end="443.952">or came from the service worker.</span> <span data-start="443.952" data-end="446.41">For requests that you know are being handled by the service</span> <span data-start="446.41" data-end="448.66">worker because you set up a route for that URL,</span> <span data-start="448.66" data-end="450.784">you can look at the time between the response start</span> <span data-start="450.784" data-end="452.83">property and the request start property</span> <span data-start="452.83" data-end="455.53">and see the total strategy time.</span> </p>
<p><span data-start="455.53" data-end="458.02">Of course, that doesn't tell you if it was just handled</span> <span data-start="458.02" data-end="460.9">by the cache, if it was handled by cache and the network.</span> <span data-start="460.9" data-end="464.89">If you need more granular timing data into that stuff,</span> <span data-start="464.89" data-end="466.69">then you have to add these performance</span> <span data-start="466.69" data-end="468.19">marks in your service worker itself.</span> <span data-start="468.19" data-end="470.41">You can use something like performance.now.</span> <span data-start="470.41" data-end="472.535">and then post message this data back to the window.</span> <span data-start="472.535" data-end="474.46">It's a bit clunky at the moment, to be honest,</span> <span data-start="474.46" data-end="477.88">but we have a new API proposal for fetch event work timing</span> <span data-start="477.88" data-end="479.8">that should make this easier in the future.</span> <span data-start="479.8" data-end="481.46">And it is a proposal right now.</span> <span data-start="481.46" data-end="483.94">So if you want to offer feedback on the design,</span> <span data-start="483.94" data-end="487">go to this short link here on the slide,</span> <span data-start="487" data-end="490.771">and we love your feedback, and you can chime in.</span> </p>
<p><span data-start="490.771" data-end="492.52">So the last call that we want to point out</span> <span data-start="492.52" data-end="495.24">is that requests made from within the service worker</span> <span data-start="495.24" data-end="496.99">can sometimes compete with higher priority</span> <span data-start="496.99" data-end="499.28">requests on the window.</span> <span data-start="499.28" data-end="502.196">And the cause of this is usually overaggressive pre-caching</span> <span data-start="502.196" data-end="504.07">or pre-caching before the window has finished</span> <span data-start="504.07" data-end="505.94">loading all of its resources.</span> <span data-start="505.94" data-end="508.09">So for example, if you're pre-caching literally</span> <span data-start="508.09" data-end="510.73">every single asset on your website,</span> <span data-start="510.73" data-end="512.409">you could potentially get to a situation</span> <span data-start="512.409" data-end="514.03">where those pre-cache requests get</span> <span data-start="514.03" data-end="518.919">queued ahead of more important requests that the user needs.</span> </p>
<p><span data-start="518.919" data-end="520.47">So while APIs like priority hints</span> <span data-start="520.47" data-end="523.5">can solve this issue somewhat, the recommended approach right</span> <span data-start="523.5" data-end="526.35">now is just to wait to register your service worker</span> <span data-start="526.35" data-end="529.087">until after the load event.</span> </p>
</section>

<section>
<p><span data-start="529.087" data-end="529.92"><span class="speaker">Ewa Gasperowicz</span>: OK.</span> <span data-start="529.92" data-end="533.01">Thanks, Phil, for the thorough walkthrough through the costs.</span> </p>
<p><span data-start="533.01" data-end="536.55">So once we know all this and we know how to measure it,</span> <span data-start="536.55" data-end="540.45">how does this translate into the design of Service Worker?</span> <span data-start="540.45" data-end="543.87">Well, usually there are three sources the service worker gets</span> <span data-start="543.87" data-end="547.62">content from, either from network, either from the cache,</span> <span data-start="547.62" data-end="549.48">or it can also generate it on the fly,</span> <span data-start="549.48" data-end="552.93">for example, by using some templating logic.</span> </p>
<p><span data-start="552.93" data-end="555.24">When designing Service Worker, your role</span> <span data-start="555.24" data-end="558.69">is to find a combination of these three sources</span> <span data-start="558.69" data-end="560.79">that is the most efficient for the use</span> <span data-start="560.79" data-end="562.62">cases on your web pages.</span> <span data-start="562.62" data-end="565.86">This is the serving strategy of Service Worker.</span> </p>
<p><span data-start="565.86" data-end="568.17">Of course, in order to use anything from the cache,</span> <span data-start="568.17" data-end="570.54">we need to populate it first with the resources first.</span> <span data-start="570.54" data-end="574.69">And this is the caching strategy of Service Worker.</span> <span data-start="574.69" data-end="578.14">Taking all these aspects into account can be quite daunting,</span> <span data-start="578.14" data-end="581">but fortunately there are tools that make it easier.</span> <span data-start="581" data-end="583.51">For example, Workbox is a set of libraries</span> <span data-start="583.51" data-end="585.46">that make it easy to cache assets</span> <span data-start="585.46" data-end="588.61">and take advantage of Service Worker features and related</span> <span data-start="588.61" data-end="590.2">APIs.</span> </p>
<p><span data-start="590.2" data-end="593.77">In this talk we'll focus on the general design principles</span> <span data-start="593.77" data-end="596.87">that you can implement yourself in Service Worker.</span> <span data-start="596.87" data-end="600.13">But we will also call out some of the Workbox features</span> <span data-start="600.13" data-end="603.037">that can help you out in some common scenarios.</span> </p>
</section>

<section>
<p><span data-start="603.037" data-end="604.87"><span class="speaker">Phil Walton</span>: OK, so let's start with looking</span> <span data-start="604.87" data-end="608.419">at the serving strategies for Service Worker implementations.</span> <span data-start="608.419" data-end="610.96">And given what we said about the costs that can be associated</span> <span data-start="610.96" data-end="613.314">with using Service Worker, you're probably wondering,</span> <span data-start="613.314" data-end="615.73">is it possible to avoid these costs entirely and make sure</span> <span data-start="615.73" data-end="618.25">that my site actually loads faster than it would have</span> <span data-start="618.25" data-end="621.13">without the service worker?</span> </p>
<p><span data-start="621.13" data-end="623.39">So the first and arguably most important step</span> <span data-start="623.39" data-end="625.97">in building a fast site with A Service worker</span> <span data-start="625.97" data-end="628.07">is an understanding of which requests</span> <span data-start="628.07" data-end="629.9">are most important to optimize.</span> <span data-start="629.9" data-end="631.85">So broadly speaking, there are two types</span> <span data-start="631.85" data-end="634.88">of requests, navigation requests and resource requests.</span> <span data-start="634.88" data-end="637.61">Navigation requests are for your full HTML pages</span> <span data-start="637.61" data-end="639.68">and resource requests are for the assets</span> <span data-start="639.68" data-end="643.79">like JavaScript, CSS, and images that those pages then</span> <span data-start="643.79" data-end="644.81">reference.</span> <span data-start="644.81" data-end="647.3">So in my experience with talking to other developers</span> <span data-start="647.3" data-end="648.987">about Service Worker implementations,</span> <span data-start="648.987" data-end="650.57">I found that most people are generally</span> <span data-start="650.57" data-end="652.82">pretty good at responding to resource requests</span> <span data-start="652.82" data-end="655.31">from the cache, but unfortunately I</span> <span data-start="655.31" data-end="658.22">don't see a lot of people responding to navigation</span> <span data-start="658.22" data-end="659.751">requests from the cache.</span> </p>
<p><span data-start="659.751" data-end="662">And that's really too bad, because navigation requests</span> <span data-start="662" data-end="665.73">are typically where the biggest performance gains can be made.</span> <span data-start="665.73" data-end="666.767">So here's why.</span> <span data-start="666.767" data-end="668.6">The key difference between resource requests</span> <span data-start="668.6" data-end="672.05">and navigation requests is that navigation requests are likely</span> <span data-start="672.05" data-end="675">already being cached by the browser.</span> <span data-start="675" data-end="676.73">In addition, you can already use APIs</span> <span data-start="676.73" data-end="679.33">like link rel preload to warm the HTTP</span> <span data-start="679.33" data-end="681.08">cache for future requests.</span> <span data-start="681.08" data-end="683.18">So if all your service worker is doing</span> <span data-start="683.18" data-end="685.43">is pre-caching static resources, you're</span> <span data-start="685.43" data-end="688.1">essentially just recreating what the browser is already</span> <span data-start="688.1" data-end="689.66">doing for you.</span> </p>
<p><span data-start="689.66" data-end="691.5">Navigation requests, on the other hand,</span> <span data-start="691.5" data-end="692.75">are completely different.</span> <span data-start="692.75" data-end="696.2">In general it's not recommended to put caching headers on pages</span> <span data-start="696.2" data-end="698.84">that you navigate to because, obviously the content might</span> <span data-start="698.84" data-end="701.24">change but the URL doesn't, and so that can get you</span> <span data-start="701.24" data-end="702.471">into trouble.</span> </p>
<p><span data-start="702.471" data-end="703.97">Which means that navigation requests</span> <span data-start="703.97" data-end="706.91">don't benefit from the HTTP cache in the same way</span> <span data-start="706.91" data-end="708.5">that resource requests do.</span> <span data-start="708.5" data-end="711.69">They also don't work with APIs like link rel preload.</span> <span data-start="711.69" data-end="713.69">And to top all that off, navigation requests are</span> <span data-start="713.69" data-end="716.63">typically the ones that will encounter a service</span> <span data-start="716.63" data-end="719.69">worker that's not running, whereas resource requests,</span> <span data-start="719.69" data-end="722.1">by the time the service worker starts up the navigation</span> <span data-start="722.1" data-end="724.98">requests, it's already running and so those work just fine.</span> <span data-start="724.98" data-end="726.074">So don't get me wrong.</span> <span data-start="726.074" data-end="728.24">I'm not suggesting that you ignore resource requests</span> <span data-start="728.24" data-end="729.115">and don't cache them.</span> <span data-start="729.115" data-end="731.962">You should cache them, because that can give you more control</span> <span data-start="731.962" data-end="733.67">and you can get the bytecode optimization</span> <span data-start="733.67" data-end="735.081">that Ewa mentioned.</span> </p>
<p><span data-start="735.081" data-end="737.33">But what I am suggesting is that if you want your site</span> <span data-start="737.33" data-end="739.28">to be as fast as possible you have</span> <span data-start="739.28" data-end="741.56">to respond to navigation requests from the cache</span> <span data-start="741.56" data-end="743.58">as well.</span> <span data-start="743.58" data-end="745.67">So here are three practical and concrete ways</span> <span data-start="745.67" data-end="747.74">you can speed up navigation requests</span> <span data-start="747.74" data-end="749.78">and avoid most of the Service Worker costs</span> <span data-start="749.78" data-end="751.58">that I mentioned earlier.</span> </p>
<p><span data-start="751.58" data-end="754.67">First, as I just said, respond to navigation requests</span> <span data-start="754.67" data-end="755.75">from the cache.</span> <span data-start="755.75" data-end="757.82">Even if you eventually need to go to the network,</span> <span data-start="757.82" data-end="759.195">you should respond with something</span> <span data-start="759.195" data-end="761.96">right away so the user understands</span> <span data-start="761.96" data-end="764.99">that it's happening, that the request is working.</span> <span data-start="764.99" data-end="767.06">A simple way to do this with Workbox</span> <span data-start="767.06" data-end="769.7">is to use either a cache first strategy or a stale while</span> <span data-start="769.7" data-end="771.14">revalidate strategy.</span> <span data-start="771.14" data-end="772.85">Personally, I like stale while revalidate</span> <span data-start="772.85" data-end="773.96">because it gives you an opportunity</span> <span data-start="773.96" data-end="775.88">to check for updates in the background,</span> <span data-start="775.88" data-end="779.57">and then you can notify the user if there's new content.</span> </p>
<p><span data-start="779.57" data-end="781.76">In terms of performance, as you can see,</span> <span data-start="781.76" data-end="783.77">responding from the cache is generally faster</span> <span data-start="783.77" data-end="785.382">when not using a service worker.</span> <span data-start="785.382" data-end="787.34">And that's even true in cases where the service</span> <span data-start="787.34" data-end="789.53">worker's asleep and needs to start up, or in cases</span> <span data-start="789.53" data-end="791.58">where the cache is slow.</span> <span data-start="791.58" data-end="794.142">The only situation it's worse is when there's a cache miss</span> <span data-start="794.142" data-end="795.85">and you have to go to the network anyway.</span> <span data-start="795.85" data-end="798.16">But that's to be expected.</span> <span data-start="798.16" data-end="800.56">So I know what many of you here are probably thinking.</span> <span data-start="800.56" data-end="805.12">There's absolutely no way that I can respond to all navigation</span> <span data-start="805.12" data-end="806.8">requests with cache content.</span> <span data-start="806.8" data-end="808.3">I need my content to be up to date.</span> <span data-start="808.3" data-end="809.32">I need it to be fresh.</span> <span data-start="809.32" data-end="810.028">And this is true.</span> </p>
<p><span data-start="810.028" data-end="812.811">Many apps just simply cannot provide value with stale</span> <span data-start="812.811" data-end="813.31">content.</span> <span data-start="813.31" data-end="815.39">They have to have fresh content.</span> <span data-start="815.39" data-end="817.997">But just because you need to fetch something</span> <span data-start="817.997" data-end="819.58">from the network doesn't mean that you</span> <span data-start="819.58" data-end="822.64">need to fetch the entire HTML page from the network.</span> </p>
<p><span data-start="822.64" data-end="825.58">So my second tip is that when the network content is truly</span> <span data-start="825.58" data-end="829.42">required, fetch just the minimum amount of content you need,</span> <span data-start="829.42" data-end="832.06">and then combine that content with other parts</span> <span data-start="832.06" data-end="834.28">of the page, which should already be in the cache.</span> <span data-start="834.28" data-end="835.821">And even better is if you can combine</span> <span data-start="835.821" data-end="839.2">that content in the form of a streaming response to the user.</span> <span data-start="839.2" data-end="842.291">So let me show you an example of what I mean by that.</span> <span data-start="842.291" data-end="843.79">A lot of HTML pages have a structure</span> <span data-start="843.79" data-end="845.18">that looks something like this.</span> <span data-start="845.18" data-end="848.11">You have kind of a head section, a header, navigation, sidebar,</span> <span data-start="848.11" data-end="850.03">footer, and lot of these sections of the page</span> <span data-start="850.03" data-end="853.66">repeat on every single page throughout your site.</span> <span data-start="853.66" data-end="856.36">The only thing that changes is often a single content area,</span> <span data-start="856.36" data-end="857.88">like you can see here.</span> </p>
<p><span data-start="857.88" data-end="860.32">So in these types of situations, clearly</span> <span data-start="860.32" data-end="861.97">it's more efficient to just fetch</span> <span data-start="861.97" data-end="864.7">the stuff that's changed rather than fetching all of that stuff</span> <span data-start="864.7" data-end="865.454">every time.</span> <span data-start="865.454" data-end="867.37">If you've ever built a single page application</span> <span data-start="867.37" data-end="869.495">you're probably kind of familiar with this concept,</span> <span data-start="869.495" data-end="872.3">though the streaming part might be new to you.</span> </p>
<p><span data-start="872.3" data-end="874.69">So here's a visualization of the performance breakdown</span> <span data-start="874.69" data-end="877.06">between traditional network responses</span> <span data-start="877.06" data-end="879.07">and a streaming response that combines network</span> <span data-start="879.07" data-end="881.72">content with cache content.</span> <span data-start="881.72" data-end="884.71">So in the example on top, since the network request</span> <span data-start="884.71" data-end="887.806">is for the full HTML page, you can see it takes a long time,</span> <span data-start="887.806" data-end="889.18">and in the example on the bottom,</span> <span data-start="889.18" data-end="892.349">the network request is for a smaller part of the HTML,</span> <span data-start="892.349" data-end="894.14">and so there's less data to be transferred.</span> <span data-start="894.14" data-end="896.54">So it will typically take less time.</span> <span data-start="896.54" data-end="900.01">In addition, the cached content can be fetched in parallel</span> <span data-start="900.01" data-end="901.78">with the network content so it doesn't</span> <span data-start="901.78" data-end="905.17">add to the total time it takes to make the request.</span> </p>
<p><span data-start="905.17" data-end="908.47">And lastly —  and this is the best part about streaming — </span> <span data-start="908.47" data-end="909.94">since it is a stream, we don't have</span> <span data-start="909.94" data-end="912.37">to wait until all the content is available to start</span> <span data-start="912.37" data-end="914.11">sending something to the user.</span> <span data-start="914.11" data-end="916.06">As soon as we have the cached content</span> <span data-start="916.06" data-end="918.13">from the start of the page, the header section,</span> <span data-start="918.13" data-end="919.847">we can send it to the user right away.</span> <span data-start="919.847" data-end="921.43">And then we can just add to the stream</span> <span data-start="921.43" data-end="924.38">once we get more network content in later.</span> </p>
<p><span data-start="924.38" data-end="927.79">So the overall experience is a much faster time to first byte</span> <span data-start="927.79" data-end="931.42">and then a faster time overall as well</span> <span data-start="931.42" data-end="933.13">If you've never used streams before, you</span> <span data-start="933.13" data-end="934.846">might be a little bit scared of the idea.</span> </p>
<p><span data-start="934.846" data-end="936.22">You might think it's complicated.</span> <span data-start="936.22" data-end="939.23">But actually, with Workbox it's really easy.</span> <span data-start="939.23" data-end="941.77">So what you do is you just register a route like you would</span> <span data-start="941.77" data-end="944.83">do with any Workbox strategy, and then</span> <span data-start="944.83" data-end="947.77">you invoke the strategy function from the Workbox streams</span> <span data-start="947.77" data-end="949.61">package.</span> <span data-start="949.61" data-end="951.92">The strategy function takes an array of other Workbox</span> <span data-start="951.92" data-end="954.26">strategies and each of these is expected</span> <span data-start="954.26" data-end="956.87">to resolve to a response that you then stitch together,</span> <span data-start="956.87" data-end="960.17">and Workbox stitches it together in the form of a stream.</span> </p>
<p><span data-start="960.17" data-end="962.54">In this case, I'm using cache first</span> <span data-start="962.54" data-end="964.58">for the header part and footer part,</span> <span data-start="964.58" data-end="966.72">and I'm using network first for the content</span> <span data-start="966.72" data-end="969.075">so I can make sure that it's fresh.</span> <span data-start="969.075" data-end="969.95">And that's really it.</span> <span data-start="969.95" data-end="971.99">Workbox takes care of merging this concept together</span> <span data-start="971.99" data-end="973.948">in a stream, and if the browser doesn't support</span> <span data-start="973.948" data-end="979.18">streams it automatically falls back to a single text response.</span> </p>
<p><span data-start="979.18" data-end="980.556">And because the strategy requests</span> <span data-start="980.556" data-end="982.388">less content from the network and because it</span> <span data-start="982.388" data-end="984.03">can read from the cache in parallel,</span> <span data-start="984.03" data-end="985.74">it's typically quite a bit faster</span> <span data-start="985.74" data-end="987.356">than the no service worker case.</span> <span data-start="987.356" data-end="988.98">Of course, the actual speed differences</span> <span data-start="988.98" data-end="991.62">will depend on the size of the content area</span> <span data-start="991.62" data-end="993.439">relative to the entire HTML page.</span> <span data-start="993.439" data-end="994.98">And that will vary from site to site.</span> <span data-start="994.98" data-end="997.8">But in general, streaming cache content with network content</span> <span data-start="997.8" data-end="1001.544">is one of the fastest ways to respond to navigation requests.</span> <span data-start="1001.544" data-end="1003.71">I say one of the fastest ways because there actually</span> <span data-start="1003.71" data-end="1008.16">is one more optimization that we can get this even faster.</span> </p>
<p><span data-start="1008.16" data-end="1009.77">So the last technique for speeding up</span> <span data-start="1009.77" data-end="1011.33">navigations that I want to talk about</span> <span data-start="1011.33" data-end="1014.12">is a new API called Navigation Preload, which</span> <span data-start="1014.12" data-end="1017.24">allows you to make the navigation request in parallel</span> <span data-start="1017.24" data-end="1019.25">with the service worker starting up,</span> <span data-start="1019.25" data-end="1021.74">essentially eliminating that Service Worker boot up cost</span> <span data-start="1021.74" data-end="1024.24">that I mentioned before.</span> </p>
<p><span data-start="1024.24" data-end="1026.69">So by now you've probably seen this chart many times.</span> <span data-start="1026.69" data-end="1029.359">You understand that the Service Worker boot up time can</span> <span data-start="1029.359" data-end="1031.01">extend the navigation request.</span> <span data-start="1031.01" data-end="1032.81">So with Navigation Preload, what you do is</span> <span data-start="1032.81" data-end="1035.92">you just do these requests in parallel.</span> <span data-start="1035.92" data-end="1039.369">And the way that this works is the browser that</span> <span data-start="1039.369" data-end="1043.91">sets this Service Worker navigation preload header</span> <span data-start="1043.91" data-end="1047.15">on the preload request, and then that allows your server</span> <span data-start="1047.15" data-end="1050.99">to respond to this request as it would have had the request</span> <span data-start="1050.99" data-end="1053.46">come directly from the service worker itself.</span> <span data-start="1053.46" data-end="1056.78">So for example, if you're using the streaming partials strategy</span> <span data-start="1056.78" data-end="1059.42">that I just discussed, you could respond</span> <span data-start="1059.42" data-end="1061.34">to the navigation preload request the same</span> <span data-start="1061.34" data-end="1065.12">as you would have if it had come from the service worker.</span> </p>
<p><span data-start="1065.12" data-end="1067.79">To use Navigation Preload, it's relatively easy.</span> <span data-start="1067.79" data-end="1069.54">All you have to do is enable it — </span> <span data-start="1069.54" data-end="1071.29">you probably want to feature detect first,</span> <span data-start="1071.29" data-end="1074.47">but then you enable it at any point in the lifecycle, really,</span> <span data-start="1074.47" data-end="1076.99">but it's often best to do it in the activate event.</span> </p>
<p><span data-start="1076.99" data-end="1078.88">And then once you've enabled it, fetch events</span> <span data-start="1078.88" data-end="1080.546">for navigation requests will have access</span> <span data-start="1080.546" data-end="1083.44">to a preload response property which you can then</span> <span data-start="1083.44" data-end="1086.419">use however you want.</span> <span data-start="1086.419" data-end="1088.46">And looking at the performance of this technique,</span> <span data-start="1088.46" data-end="1091.94">you'll see how navigation requests with Navigation</span> <span data-start="1091.94" data-end="1098.63">Preload are even faster than the already fast streaming example.</span> <span data-start="1098.63" data-end="1101.157">And one last thing I want to say about Navigation Preload</span> <span data-start="1101.157" data-end="1102.74">is that you really only want to use it</span> <span data-start="1102.74" data-end="1107.24">in cases where you know you're going to have to make a network</span> <span data-start="1107.24" data-end="1109.17">request on navigations.</span> </p>
<p><span data-start="1109.17" data-end="1111.5">If you can use just the cache first strategy to respond</span> <span data-start="1111.5" data-end="1113.85">to navigations, then that ends up being faster</span> <span data-start="1113.85" data-end="1116.42">and then you waste the network request.</span> <span data-start="1116.42" data-end="1117.92">So in general, only use it if you</span> <span data-start="1117.92" data-end="1120.86">know that you have to use content from the network.</span> <span data-start="1120.86" data-end="1123.579">So to summarize everything I've said so far, even though there</span> <span data-start="1123.579" data-end="1125.87">are definitely some costs associated with using Service</span> <span data-start="1125.87" data-end="1128.72">Worker, with the proper serving strategy you can easily</span> <span data-start="1128.72" data-end="1130.55">overcome these costs and you can end up</span> <span data-start="1130.55" data-end="1133.79">with a even faster loading site than what you could have</span> <span data-start="1133.79" data-end="1136.75">done without Service Worker.</span> </p>
</section>

<section>
<p><span data-start="1136.75" data-end="1138.07"><span class="speaker">Ewa Gasperowicz</span>: OK.</span> <span data-start="1138.07" data-end="1140.841">Now let's talk a bit about the caching part of the Service</span> </p>
<p><span data-start="1140.841" data-end="1141.34">Worker.</span> <span data-start="1144.05" data-end="1146.09">When we think about cache management,</span> <span data-start="1146.09" data-end="1148.34">we usually want to achieve the following.</span> <span data-start="1148.34" data-end="1151.31">We want to start the right resources at the right time</span> <span data-start="1151.31" data-end="1154.28">while controlling the overall size of our application.</span> <span data-start="1154.28" data-end="1156.53">We definitely want to prevent quota overflow,</span> <span data-start="1156.53" data-end="1159.86">because as developers, we do have quite a bit of storage</span> <span data-start="1159.86" data-end="1162.38">space on users' device, but it's not unlimited,</span> <span data-start="1162.38" data-end="1164.13">so we need to stick to that.</span> </p>
<p><span data-start="1164.13" data-end="1165.92">And we also want our resources to be</span> <span data-start="1165.92" data-end="1167.84">as fresh as possible, which means we</span> <span data-start="1167.84" data-end="1171.14">need to have efficient updates.</span> <span data-start="1171.14" data-end="1173.602">Now when it comes to right resources,</span> <span data-start="1173.602" data-end="1175.31">it's good to understand what you actually</span> <span data-start="1175.31" data-end="1178.34">want to put in the cache in the first place.</span> </p>
<p><span data-start="1178.34" data-end="1180.74">Resources are a little bit like food, you know.</span> <span data-start="1180.74" data-end="1183.5">There are the critical ones, really important ones</span> <span data-start="1183.5" data-end="1187.31">like some HTML core scripts or basic styles.</span> <span data-start="1187.31" data-end="1189.26">This should really get the highest priority</span> <span data-start="1189.26" data-end="1190.94">in terms of cache.</span> <span data-start="1190.94" data-end="1194.24">Then there are non-critical ones, for example,</span> <span data-start="1194.24" data-end="1196.64">images that are not visible straight away,</span> <span data-start="1196.64" data-end="1200.43">or some big media files or some additional widgets.</span> <span data-start="1200.43" data-end="1203.46">We cache them on the best effort basis.</span> <span data-start="1203.46" data-end="1205.79">And finally, there's trash, which</span> <span data-start="1205.79" data-end="1209.39">means stuff that should not be there in the first place.</span> </p>
<p><span data-start="1209.39" data-end="1211.85">This is the bloat, the unnecessary parts of your page,</span> <span data-start="1211.85" data-end="1217.16">like unoptimized images, dead code, unused script, and so on.</span> <span data-start="1217.16" data-end="1219.89">Why do we have trash in our pages?</span> <span data-start="1219.89" data-end="1222.47">Well, because we're humans and sometimes</span> <span data-start="1222.47" data-end="1226.07">our projects are simply not perfect.</span> <span data-start="1226.07" data-end="1227.57">This moment, when you're considering</span> <span data-start="1227.57" data-end="1230.62">how to shape your caching strategy for Service Worker,</span> <span data-start="1230.62" data-end="1233.09">is a great time to stop for a while,</span> <span data-start="1233.09" data-end="1235.13">make an audit of your page, and get</span> <span data-start="1235.13" data-end="1238.55">rid of all that unnecessary part before they end up</span> <span data-start="1238.55" data-end="1242.07">clogging your user's device.</span> </p>
<p><span data-start="1242.07" data-end="1244.04">So reviewing your app and understanding</span> <span data-start="1244.04" data-end="1247.37">which resources are critical and which are not so critical</span> <span data-start="1247.37" data-end="1250.36">will really help you later in designing and updating</span> <span data-start="1250.36" data-end="1253.11">your cache in an efficient manner.</span> <span data-start="1253.11" data-end="1255.55">Now what about timing?</span> <span data-start="1255.55" data-end="1258.7">Usually we cache assets either in the install event of Service</span> <span data-start="1258.7" data-end="1259.24">Worker — </span> <span data-start="1259.24" data-end="1262.51">that's usually pre-caching —  or later during the runtime</span> <span data-start="1262.51" data-end="1264.23">of our application.</span> <span data-start="1264.23" data-end="1265.78">Let's compare these two.</span> <span data-start="1265.78" data-end="1268.57">So pre-caching is very similar to installing</span> <span data-start="1268.57" data-end="1271.18">a ready-made package with your app.</span> </p>
<p><span data-start="1271.18" data-end="1274">It's great for caching the critical content,</span> <span data-start="1274" data-end="1278.8">since we know it's most probably going to be needed anyways.</span> <span data-start="1278.8" data-end="1281.62">It's relatively easy to implement and to manage</span> <span data-start="1281.62" data-end="1284.56">and to update, because you can just replace the whole package</span> <span data-start="1284.56" data-end="1286.9">with the new version when needed,</span> <span data-start="1286.9" data-end="1289.06">and also because the size of such package</span> <span data-start="1289.06" data-end="1291.35">is known beforehand.</span> </p>
<p><span data-start="1291.35" data-end="1293.18">On the other hand, when using pre-caching,</span> <span data-start="1293.18" data-end="1295.82">you need to make a lot of arbitrary decisions</span> <span data-start="1295.82" data-end="1299.03">about what your user is going to need even before they start</span> <span data-start="1299.03" data-end="1302.78">interacting with the page, which might lead to the situation</span> <span data-start="1302.78" data-end="1307.38">where you cache many more resources than necessary.</span> <span data-start="1307.38" data-end="1310.97">Also, as we mentioned before, it can cause network congestion</span> <span data-start="1310.97" data-end="1313.55">and compete with the other network requests</span> <span data-start="1313.55" data-end="1316.24">from the window.</span> <span data-start="1316.24" data-end="1318.11">Runtime caching, on the other hand,</span> <span data-start="1318.11" data-end="1320.32">is really great for non-critical assets</span> <span data-start="1320.32" data-end="1323.53">because you can draw conclusions from your user's behavior.</span> <span data-start="1323.53" data-end="1326.35">For example cache only images they already</span> <span data-start="1326.35" data-end="1331.48">accessed, or cache different parts of your app</span> <span data-start="1331.48" data-end="1334.86">depending on the user's entry point.</span> <span data-start="1334.86" data-end="1336.87">On the other hand, the problem with runtime</span> <span data-start="1336.87" data-end="1339.87">is that you need to be really careful about updates</span> <span data-start="1339.87" data-end="1341.94">because assets might end up in cache</span> <span data-start="1341.94" data-end="1344.17">at different moments in time.</span> </p>
<p><span data-start="1344.17" data-end="1346.44">For example, if resources depend on each other,</span> <span data-start="1346.44" data-end="1349.08">like you have a script that depends on the markup</span> <span data-start="1349.08" data-end="1351.69">and you end up caching incompatible versions of them,</span> <span data-start="1351.69" data-end="1352.63">you run into trouble.</span> <span data-start="1352.63" data-end="1355.8">So you need to be very careful about versioning.</span> <span data-start="1355.8" data-end="1358.39">Also, important thing is that in this case,</span> <span data-start="1358.39" data-end="1360.2">the cache will grow over time.</span> <span data-start="1360.2" data-end="1362.37">The size is not known beforehand.</span> </p>
<p><span data-start="1362.37" data-end="1365.28">So as the user interacts with the app,</span> <span data-start="1365.28" data-end="1368.35">the size will be different.</span> <span data-start="1368.35" data-end="1369.58">Here's an example.</span> <span data-start="1369.58" data-end="1372.78">This is a very simple e-commerce app I built recently.</span> <span data-start="1372.78" data-end="1376.47">If I cache pages in this app at runtime</span> <span data-start="1376.47" data-end="1378.39">and the homepage is fully cached,</span> <span data-start="1378.39" data-end="1382.2">it takes about 150 kilobytes with all the images.</span> <span data-start="1382.2" data-end="1384.6">But later when the user navigates to a new category,</span> <span data-start="1384.6" data-end="1388.23">like accessories page, it gets added to the cache,</span> <span data-start="1388.23" data-end="1391.5">and the overall size grows to 300 kilobytes.</span> <span data-start="1391.5" data-end="1392.49">And so on and so on.</span> <span data-start="1392.49" data-end="1396.456">As the user interacts with my app, the overall size grows.</span> <span data-start="1396.456" data-end="1397.83">If the app is really big it might</span> <span data-start="1397.83" data-end="1401.01">be really hard to predict ahead of time how much space it</span> <span data-start="1401.01" data-end="1403.02">will take on users' device.</span> </p>
<p><span data-start="1403.02" data-end="1406.92">This is why it's so important to control the size of your app</span> <span data-start="1406.92" data-end="1408.77">through the runtime.</span> <span data-start="1408.77" data-end="1411.57">Phil, can we do it programmatically somehow?</span> </p>
</section>

<section>
<p><span data-start="1411.57" data-end="1413.22"><span class="speaker">Phil Walton</span>: You can.</span> <span data-start="1413.22" data-end="1417.03">If you ever need to check your app's current storage usage,</span> <span data-start="1417.03" data-end="1419.64">you can use the Storage Manager API which</span> <span data-start="1419.64" data-end="1423.48">has an estimate method that returns, both the total quota</span> <span data-start="1423.48" data-end="1426.824">as well as the current amount that's being used.</span> </p>
</section>

<section>
<p><span data-start="1426.824" data-end="1428.24"><span class="speaker">Ewa Gasperowicz</span>: Well, it's really</span> <span data-start="1428.24" data-end="1430.62">cool that we can estimate that, because it</span> <span data-start="1430.62" data-end="1433.41">allows us to proactively control the app size</span> <span data-start="1433.41" data-end="1435.68">and prevent quota overflow.</span> <span data-start="1435.68" data-end="1439.17">Quota is limited and depends both on users' device</span> <span data-start="1439.17" data-end="1442.53">and also on the amount of currently available space</span> <span data-start="1442.53" data-end="1443.92">on the device.</span> </p>
<p><span data-start="1443.92" data-end="1446.46">So you can't just throw assets into the cache</span> <span data-start="1446.46" data-end="1448.83">and assume it will never fill up.</span> <span data-start="1448.83" data-end="1451.68">You always need to have a plan on how to remove</span> <span data-start="1451.68" data-end="1453.589">old or unnecessary assets.</span> <span data-start="1453.589" data-end="1455.13">After all, you don't want a situation</span> <span data-start="1455.13" data-end="1457.83">where you can't update some critical script</span> <span data-start="1457.83" data-end="1460.35">because your cache is full of cat videos.</span> <span data-start="1463.5" data-end="1465">Here are some things that can help</span> <span data-start="1465" data-end="1467.16">you to stay below the quota.</span> </p>
<p><span data-start="1467.16" data-end="1469.44">As we mentioned before, you can store</span> <span data-start="1469.44" data-end="1472.71">partials of your pages instead of full HTML</span> <span data-start="1472.71" data-end="1475.92">to avoid duplication and save some space.</span> <span data-start="1475.92" data-end="1478.74">You can also separate your critical and non-critical</span> <span data-start="1478.74" data-end="1481.92">assets into different caches with different names,</span> <span data-start="1481.92" data-end="1485.22">so that you can evict the non-critical ones when needed</span> <span data-start="1485.22" data-end="1488.15">without touching the rest.</span> </p>
<p><span data-start="1488.15" data-end="1491.15">Finally, you can also cache some resources</span> <span data-start="1491.15" data-end="1494.21">only if there is plenty of space, like conditionally.</span> <span data-start="1494.21" data-end="1498.08">Or you can put size or maximum number of entries constraints</span> <span data-start="1498.08" data-end="1499.34">on your cache.</span> <span data-start="1499.34" data-end="1501.62">I think this is something Workbox can help us with.</span> </p>
</section>

<section>
<p><span data-start="1501.62" data-end="1502.37"><span class="speaker">Phil Walton</span>: Yeah.</span> </p>
<p><span data-start="1502.37" data-end="1504.62">With Workbox you can easily manage the rules</span> <span data-start="1504.62" data-end="1507.89">for how and when cache entries should expire with the Cache</span> <span data-start="1507.89" data-end="1509.21">Expiration plugin.</span> <span data-start="1509.21" data-end="1512.63">And you can use it with any of the Workbox strategies.</span> <span data-start="1512.63" data-end="1515.45">So you configure both a max number of entries per cache</span> <span data-start="1515.45" data-end="1517.77">or a max age for each entry.</span> <span data-start="1517.77" data-end="1520">You can also configure the plugin</span> <span data-start="1520" data-end="1522.207">to automatically purge all entries if there</span> <span data-start="1522.207" data-end="1523.79">is any kind of quota error or anything</span> <span data-start="1523.79" data-end="1525.456">like that, which is usually a good thing</span> <span data-start="1525.456" data-end="1529.59">to do when you have a non-critical asset cache.</span> </p>
<p></p>
</section>

<section>
<p><span data-start="1529.59" data-end="1533.22"><span class="speaker">Ewa Gasperowicz</span>: OK, now a few words about updating the cache.</span> <span data-start="1533.22" data-end="1536.67">The simplest solution is what I call the nuke approach, which</span> <span data-start="1536.67" data-end="1539.64">means you clear all your caches and start fresh every time</span> <span data-start="1539.64" data-end="1541.44">your service worker updates.</span> <span data-start="1541.44" data-end="1543.93">It's very easy to implement, but it's not</span> <span data-start="1543.93" data-end="1547.74">very efficient nor kind to your user's data plans.</span> <span data-start="1547.74" data-end="1550.99">So you should be more granular about what you update and when.</span> <span data-start="1550.99" data-end="1553.23">And if you want to be more granular,</span> <span data-start="1553.23" data-end="1555.45">you need to properly tag your assets</span> <span data-start="1555.45" data-end="1559.45">so that you know which ones are compatible with each other.</span> <span data-start="1559.45" data-end="1561.21">You can use the content-based hashes</span> <span data-start="1561.21" data-end="1563.79">in the file name of the given resource,</span> <span data-start="1563.79" data-end="1566.13">or provide revision data on each asset</span> <span data-start="1566.13" data-end="1569.55">so that you can manage it in Service Worker later on.</span> </p>
<p><span data-start="1569.55" data-end="1572.37">This process can be very error-prone when done manually,</span> <span data-start="1572.37" data-end="1574.77">so fortunately we have tools to help with that as well.</span> </p>
</section>

<section>
<p><span data-start="1574.77" data-end="1577.68"><span class="speaker">Phil Walton</span>: Yeah, with the Workbox pre-caching package,</span> <span data-start="1577.68" data-end="1580.35">you don't have to manually manage the update</span> <span data-start="1580.35" data-end="1581.4">process yourself at all.</span> <span data-start="1581.4" data-end="1584.97">It has an asset manifest that maps file URLs</span> <span data-start="1584.97" data-end="1587.28">to their revision hashes, and that</span> <span data-start="1587.28" data-end="1589.35">allows it to remove old assets and fetch</span> <span data-start="1589.35" data-end="1592.86">new ones without having to touch any of the unchanged assets.</span> </p>
<p><span data-start="1592.86" data-end="1595.88">It makes the upgrade process really efficient.</span> <span data-start="1595.88" data-end="1599.97">Workbox also has both Gulp and Webpack plugins, as well as</span> <span data-start="1599.97" data-end="1601.92">a CLI, so you can easily generate</span> <span data-start="1601.92" data-end="1605.21">this asset manifest yourself.</span> </p>
</section>

<section>
<p><span data-start="1605.21" data-end="1608"><span class="speaker">Ewa Gasperowicz</span>: As you can see, Workbox makes a lot of things</span> <span data-start="1608" data-end="1610.37">easier for us as developers so that we</span> <span data-start="1610.37" data-end="1614.3">can focus on what matters most, and that's the user.</span> <span data-start="1614.3" data-end="1618.11">And users can really vary.</span> <span data-start="1618.11" data-end="1619.61">They can be of different background,</span> <span data-start="1619.61" data-end="1622.55">they can use our app at home or on the go,</span> <span data-start="1622.55" data-end="1624.86">they can use more or less advanced devices</span> <span data-start="1624.86" data-end="1628.79">or have different access to data and connectivity.</span> <span data-start="1628.79" data-end="1631.82">There are some things we can do to accommodate</span> <span data-start="1631.82" data-end="1634.28">those differences.</span> </p>
<p><span data-start="1634.28" data-end="1636.03">First of all, when working on performance,</span> <span data-start="1636.03" data-end="1638.19">never assume the environment you work in</span> <span data-start="1638.19" data-end="1640.559">is representative of your whole user base.</span> <span data-start="1640.559" data-end="1642.725">For example, you should always throttle your network</span> <span data-start="1642.725" data-end="1646.32">to 3G speed when testing to get a more realistic feel</span> <span data-start="1646.32" data-end="1649.06">for your performance.</span> <span data-start="1649.06" data-end="1652.12">Secondly, keep in mind those underpowered devices</span> <span data-start="1652.12" data-end="1655.63">with little storage and really control the size of your app.</span> </p>
<p><span data-start="1655.63" data-end="1657.49">Remember that the overall size of your app</span> <span data-start="1657.49" data-end="1660.07">might grow over time if you use runtime caching,</span> <span data-start="1660.07" data-end="1662.75">and plan accordingly.</span> <span data-start="1662.75" data-end="1664.63">Also, sometimes there are actually</span> <span data-start="1664.63" data-end="1667.06">explicit hints from the user that you can</span> <span data-start="1667.06" data-end="1669.28">use in your decision making.</span> <span data-start="1669.28" data-end="1672.97">For example, you can refrain from speculatively pre-caching</span> <span data-start="1672.97" data-end="1677.08">future resources if the Data Saver mode is turned on.</span> <span data-start="1677.08" data-end="1679.69">When user enables this feature in Chrome,</span> <span data-start="1679.69" data-end="1682.31">the save data header is being sent with each request.</span> </p>
<p><span data-start="1682.31" data-end="1684.76">So you can detect it and, for example,</span> <span data-start="1684.76" data-end="1686.24">refrain from aggressive pre-caching</span> <span data-start="1686.24" data-end="1688.9">a lot of future assets.</span> <span data-start="1688.9" data-end="1692.32">Similarly, you can use the Network Information API</span> <span data-start="1692.32" data-end="1695.5">effective type method to differentiate your strategy</span> <span data-start="1695.5" data-end="1699.58">based on the current network condition of the user.</span> </p>
<p><span data-start="1699.58" data-end="1702.34">Finally, you can also consider scenarios</span> <span data-start="1702.34" data-end="1705.59">where you give the user the full control over the experience.</span> <span data-start="1705.59" data-end="1708.64">For example, you provide save for later button, where</span> <span data-start="1708.64" data-end="1712.57">a user can explicitly opt in and decide to get something stored</span> <span data-start="1712.57" data-end="1714.98">for future use.</span> <span data-start="1714.98" data-end="1716.45">Putting the user first can really</span> <span data-start="1716.45" data-end="1719.42">benefit the quality of your app, especially</span> <span data-start="1719.42" data-end="1722.754">in the long term development horizon.</span> </p>
</section>

<section>
<p><span data-start="1722.754" data-end="1724.17"><span class="speaker">Phil Walton</span>: So to wrap up, I know</span> <span data-start="1724.17" data-end="1725.91">we've presented a lot of content today,</span> <span data-start="1725.91" data-end="1729.027">and we don't expect you to remember everything.</span> </p>
<p><span data-start="1729.027" data-end="1731.61">If you want to learn more about Service Worker best practices,</span> <span data-start="1731.61" data-end="1733.98">we've launched a new section on web.dev</span> <span data-start="1733.98" data-end="1736.696">with content dedicated to building fast and resilient web</span> <span data-start="1736.696" data-end="1738.07">applications with Service Worker.</span> <span data-start="1738.07" data-end="1740.17">So definitely check that out.</span> <span data-start="1740.17" data-end="1743.1">Also, we've just released a V4 beta of Workbox</span> <span data-start="1743.1" data-end="1745.26">with lots of cool new features, and we'd</span> <span data-start="1745.26" data-end="1748.74">love your feedback on GitHub before the public release.</span> <span data-start="1748.74" data-end="1750.75">And finally, just a few key points</span> <span data-start="1750.75" data-end="1751.99">we want to leave you with.</span> <span data-start="1751.99" data-end="1754.74">First, definitely have a plan.</span> <span data-start="1754.74" data-end="1757.29">You can't just assume that adding Service Worker to a site</span> <span data-start="1757.29" data-end="1760.8">will magically make it faster, because without an optimization</span> <span data-start="1760.8" data-end="1763.2">plan it probably won't.</span> <span data-start="1763.2" data-end="1766.11">Second, don't just reinvent the HTTP cache</span> <span data-start="1766.11" data-end="1768.69">inside of your service worker, and don't just</span> <span data-start="1768.69" data-end="1770.212">cache static resources.</span> </p>
<p><span data-start="1770.212" data-end="1772.17">If that's all you're doing, you're not actually</span> <span data-start="1772.17" data-end="1773.94">optimizing your site for Service Worker</span> <span data-start="1773.94" data-end="1776.46">and you might even be making it slower.</span> <span data-start="1776.46" data-end="1778.77">Third, remember that navigation requests are</span> <span data-start="1778.77" data-end="1781.83">the most important requests to optimize,</span> <span data-start="1781.83" data-end="1785.31">and you should always try to respond to them from the cache.</span> <span data-start="1785.31" data-end="1788.28">Fourth, measure the real user performance</span> <span data-start="1788.28" data-end="1791.55">of your implementations and make future performance decisions</span> <span data-start="1791.55" data-end="1792.66">based on data.</span> <span data-start="1792.66" data-end="1794.4">Don't just guess.</span> <span data-start="1794.4" data-end="1796.47">Fifth, control the size of your app</span> <span data-start="1796.47" data-end="1799.45">and how much you store on the user's device.</span> <span data-start="1799.45" data-end="1802.05">And last but definitely not least, respect the user,</span> <span data-start="1802.05" data-end="1805.72">respect their data, and respect their preferences.</span> </p>
<p><span data-start="1805.72" data-end="1806.22">Thank you.</span> <span data-start="1806.22" data-end="1808.595">If you have any questions, feel free to find either of us</span> <span data-start="1808.595" data-end="1812.13">afterwards, or hit us up on Twitter and ask questions.</span> <span data-start="1812.13" data-end="1813.06">That's it, yeah.</span> </p>
</section>

<section>
<p><span data-start="1813.06" data-end="1814.184"><span class="speaker">Ewa Gasperowicz</span>: Thank you.</span> <span data-start="1814.184" data-end="1816.92">[MUSIC PLAYING]</span> </p>
</section>
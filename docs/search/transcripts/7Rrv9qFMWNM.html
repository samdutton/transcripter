<section>
<p><span data-start="0" data-end="3.311">[MUSIC PLAYING]</span> </p>
</section>

<section>
<p><span data-start="5.68" data-end="8.71"><span class="speaker">Surma</span>: The main thread is overworked and underpaid.</span> <span data-start="8.71" data-end="12.55">And yet all of us run their code almost exclusively</span> <span data-start="12.55" data-end="13.93">on the main thread.</span> <span data-start="13.93" data-end="16.3">And I'm not wagging my finger at you.</span> <span data-start="16.3" data-end="18.71">This has been the norm.</span> <span data-start="18.71" data-end="21.67">This is the best practice on the web currently.</span> <span data-start="21.67" data-end="23.11">And it makes sense because, if you</span> <span data-start="23.11" data-end="27.25">had the choice between driving your car on the main road</span> <span data-start="27.25" data-end="30.91">or on a side alley, you would drive it on the main road.</span> <span data-start="30.91" data-end="33.4">And so what I'm really saying is the main thread</span> <span data-start="33.4" data-end="35.47">is overworked and underpaid — </span> <span data-start="35.47" data-end="37.94">and the name is bad, too — </span> <span data-start="37.94" data-end="38.44">really?</span> </p>
<p><span data-start="42.74" data-end="43.958">So what is this all about?</span> <span data-start="43.958" data-end="46.25">Well, this whole thing started to become a topic for me</span> <span data-start="46.25" data-end="48.02">when I was researching people coming</span> <span data-start="48.02" data-end="49.9">online for the first time.</span> <span data-start="49.9" data-end="52.58">50% of the world's population are currently</span> <span data-start="52.58" data-end="58.01">online, which means that 50% are not, or at least, not yet.</span> <span data-start="58.01" data-end="62.66">These 50% are now slowly coming online through a vast variety</span> <span data-start="62.66" data-end="63.74">of devices.</span> <span data-start="63.74" data-end="65.53">For example, feature phones —  they</span> <span data-start="65.53" data-end="68.93">have been incredibly popular for a long time in emerging markets</span> <span data-start="68.93" data-end="69.83">like India.</span> <span data-start="69.83" data-end="72.02">They are incredibly cheap to manufacture</span> <span data-start="72.02" data-end="77.24">and, as such, they can be sold for a very low price tag,</span> <span data-start="77.24" data-end="81.01">bringing more people from the world of offline to online.</span> </p>
<p><span data-start="81.01" data-end="84.08">So the Jio Phone that you can see here on the very right</span> <span data-start="84.08" data-end="87.8">is running a fork off the old Firefox OS called KaiOS,</span> <span data-start="87.8" data-end="90.47">which is based on Firefox 42.</span> <span data-start="90.47" data-end="94.13">So that isn't a recent version of Firefox by any means.</span> <span data-start="94.13" data-end="98.49">But it is modern enough to browse the current web.</span> <span data-start="98.49" data-end="101.03">And this phone only costs $15, which</span> <span data-start="101.03" data-end="103.4">means the phone is incredibly popular</span> <span data-start="103.4" data-end="107.18">and makes the mobile internet accessible to many more people</span> <span data-start="107.18" data-end="108.95">than before.</span> <span data-start="108.95" data-end="111.2">And these people coming online for the first time</span> <span data-start="111.2" data-end="114.2">with comparatively low-powered phones</span> <span data-start="114.2" data-end="118.56">are sometimes referred to as the Next Billion Users, or NBU.</span> </p>
<p><span data-start="118.56" data-end="121.25">And I know that many of you hear this and might think</span> <span data-start="121.25" data-end="123.42">of emerging markets like India.</span> <span data-start="123.42" data-end="124.92">And that is absolutely not wrong.</span> <span data-start="124.92" data-end="127.43">But it's also not the entire story,</span> <span data-start="127.43" data-end="130.797">because there are also people in America.</span> <span data-start="130.797" data-end="133.13">Now, they might not be coming online for the first time,</span> <span data-start="133.13" data-end="133.94">necessarily.</span> <span data-start="133.94" data-end="136.34">But they do spend their time on devices</span> <span data-start="136.34" data-end="138.99">with very similar performance characteristics,</span> <span data-start="138.99" data-end="141.025">for example, the Nokia 2.</span> <span data-start="141.025" data-end="144.68">The Nokia 2 is a great phone because it is nice looking,</span> <span data-start="144.68" data-end="148.46">it is very cheap, and it runs modern Android.</span> <span data-start="148.46" data-end="151.55">However, the Nokia 2 smartphone is as smart</span> <span data-start="151.55" data-end="153.05">as Iron Man is iron.</span> </p>
<p><span data-start="153.05" data-end="155">There is a resemblance from the outside,</span> <span data-start="155" data-end="157.07">but it's really made from something much more</span> <span data-start="157.07" data-end="158.63">lightweight.</span> <span data-start="158.63" data-end="162.32">So now these Americans that have phones like the Nokia 2</span> <span data-start="162.32" data-end="165.08">have these phones because they are subsidized.</span> <span data-start="165.08" data-end="167.06">These phones are available at little</span> <span data-start="167.06" data-end="170.84">or almost no cost for people living below the poverty line.</span> <span data-start="170.84" data-end="174.29">And that is around 16% of Americans.</span> <span data-start="174.29" data-end="176.6">And similar programs exist in other countries</span> <span data-start="176.6" data-end="178.65">in the Western world.</span> </p>
<p><span data-start="178.65" data-end="181.25">So to compare, look at how the iPhones</span> <span data-start="181.25" data-end="184.01">have been climbing the single-core benchmark</span> <span data-start="184.01" data-end="185.01">over the years.</span> <span data-start="185.01" data-end="187.25">They are absolute beasts, and they continue</span> <span data-start="187.25" data-end="189.02">to keep getting faster.</span> <span data-start="189.02" data-end="192.41">The Nokia 2, on the other hand, is down here.</span> <span data-start="192.41" data-end="195.56">It came out in 2018, but it's pretty much on par</span> <span data-start="195.56" data-end="197.57">with the iPhone from 2011.</span> <span data-start="197.57" data-end="198.8">That's seven years ago.</span> <span data-start="198.8" data-end="201.14">It's ancient for technology standards.</span> <span data-start="201.14" data-end="203.9">And yet, this ancient hardware runs a modern version</span> <span data-start="203.9" data-end="206.36">of Android with the most recent version of Chrome.</span> <span data-start="206.36" data-end="211.31">So you get all the modern, new APIs, but on old hardware.</span> <span data-start="211.31" data-end="216.05">So you should be looking at the Nokia 2 or a similar phone</span> <span data-start="216.05" data-end="221.48">to see how your web app feels for up to 16% of Americans.</span> <span data-start="221.48" data-end="224.03">Or to phrase it another way, the Nokia 2.1</span> <span data-start="224.03" data-end="227.12">is probably representative as a 95th percentile</span> <span data-start="227.12" data-end="228.76">phone for America.</span> </p>
<p><span data-start="228.76" data-end="231.32">If your app runs on this phone, your app</span> <span data-start="231.32" data-end="235.04">will be usable for 95% of Americans.</span> <span data-start="235.04" data-end="236.27">And that's just America.</span> <span data-start="236.27" data-end="238.58">Globally, the percentiles are skewed much more</span> <span data-start="238.58" data-end="242.12">towards the low-end spectrum of phones.</span> <span data-start="242.12" data-end="244.04">Either way, you should try out this phone</span> <span data-start="244.04" data-end="246.7">and see how your web app feels.</span> <span data-start="246.7" data-end="248.62">The bottom line is here that, even</span> <span data-start="248.62" data-end="250.63">in the wealthy Western world, we need</span> <span data-start="250.63" data-end="253.18">to care about hyperconstrained devices</span> <span data-start="253.18" data-end="257.14">with crappy CPUs, pretty much no GPUs, small screens,</span> <span data-start="257.14" data-end="259.149">and sometimes even no touch.</span> </p>
<p><span data-start="259.149" data-end="260.98">And more precisely, we need to start caring</span> <span data-start="260.98" data-end="264.79">about people who are constrained to these kind of devices.</span> <span data-start="264.79" data-end="269.09">And as an exercise in this, we wrote PROXX earlier this year.</span> <span data-start="269.09" data-end="271.1">It's a minesweeper clone as a PWA.</span> </p>
<p><span data-start="271.1" data-end="275.2">So it has all the PWA goodies, like offline and nice graphics.</span> <span data-start="275.2" data-end="279.1">And it was projected that around 400 million phones, feature</span> <span data-start="279.1" data-end="282.22">phones, would be sold in 2019 alone.</span> <span data-start="282.22" data-end="285.22">So we explicitly wanted to include that audience</span> <span data-start="285.22" data-end="287.95">in our target audience so that they can play on these devices</span> <span data-start="287.95" data-end="289.845">as well.</span> <span data-start="289.845" data-end="291.22">So we wanted to see what it takes</span> <span data-start="291.22" data-end="293.47">to make a game run on devices like this,</span> <span data-start="293.47" data-end="296.62">these hyperconstrained devices, without writing a completely</span> <span data-start="296.62" data-end="298.53">separate version of the game.</span> </p>
<p><span data-start="298.53" data-end="299.95">And a couple of early experiments</span> <span data-start="299.95" data-end="303.7">showed that we are really pushing the performance</span> <span data-start="303.7" data-end="306.13">boundaries of these devices by something as simple</span> <span data-start="306.13" data-end="309.07">as a table with a couple of buttons and some JavaScript</span> <span data-start="309.07" data-end="310.42">to update the table.</span> <span data-start="310.42" data-end="313.55">The main thread was completely overworked.</span> <span data-start="313.55" data-end="316.51">So what is the main thread?</span> <span data-start="316.51" data-end="319.54">Since the beginning of browsers, websites only ever</span> <span data-start="319.54" data-end="320.998">had one thread.</span> <span data-start="320.998" data-end="322.54">In the early days, the entire browser</span> <span data-start="322.54" data-end="325.84">just had one thread because you just had one window.</span> </p>
<p><span data-start="325.84" data-end="327.61">If you wanted to surf multiple websites,</span> <span data-start="327.61" data-end="330.07">you would start a completely separate second instance</span> <span data-start="330.07" data-end="331.24">of that browser.</span> <span data-start="331.24" data-end="334.84">Since then, we have at least gotten one thread per tab,</span> <span data-start="334.84" data-end="336.88">kind of; there are exceptions.</span> <span data-start="336.88" data-end="338.32">But at the same time, the web has</span> <span data-start="338.32" data-end="341.44">evolved from static documents with a couple</span> <span data-start="341.44" data-end="344.62">of styles and images to new, full-blown, dynamic</span> <span data-start="344.62" data-end="345.73">applications.</span> </p>
<p><span data-start="345.73" data-end="349.75">And everything that is required to make this jump from docs</span> <span data-start="349.75" data-end="353.35">to applications has just been added to this one thread,</span> <span data-start="353.35" data-end="356.51">to the main thread, over time.</span> <span data-start="356.51" data-end="359.31">And as a result, the main thread ended up</span> <span data-start="359.31" data-end="362.46">with a lot of responsibilities when loading and running</span> <span data-start="362.46" data-end="363.48">a website.</span> <span data-start="363.48" data-end="366.45">So it has to process the events that the user causes</span> <span data-start="366.45" data-end="367.98">by scrolling or interacting with it</span> <span data-start="367.98" data-end="370.47">and figuring out if there's any JavaScript that needs to be</span> <span data-start="370.47" data-end="372.37">run in response to this event.</span> <span data-start="372.37" data-end="375.48">If there is, the browser needs to run that JavaScript, then</span> <span data-start="375.48" data-end="377.25">figure out if the JavaScript changed</span> <span data-start="377.25" data-end="379.29">the styles in which elements are affected</span> <span data-start="379.29" data-end="381.12">by the changes in these styles.</span> </p>
<p><span data-start="381.12" data-end="383.04">Then it needs to do layout to figure out</span> <span data-start="383.04" data-end="386.73">where the elements end up where on this page</span> <span data-start="386.73" data-end="388.237">and where the text flows and breaks.</span> <span data-start="388.237" data-end="389.82">And then it needs to paint everything,</span> <span data-start="389.82" data-end="392.31">meaning it needs to color in the elements' backgrounds</span> <span data-start="392.31" data-end="395.4">and the borders and the images and the text and the shadows.</span> <span data-start="395.4" data-end="398.13">And lastly, it needs to finally composite</span> <span data-start="398.13" data-end="400.23">all these individual elements into the final image</span> <span data-start="400.23" data-end="402.93">that you see on your screen.</span> </p>
<p><span data-start="402.93" data-end="404.56">Now, to put that into context, we</span> <span data-start="404.56" data-end="407.5">want to ship 60 frames a second because that's</span> <span data-start="407.5" data-end="409.84">what it takes to make scrolling or animations</span> <span data-start="409.84" data-end="414.1">feel smooth to, well, humans with human psychology.</span> <span data-start="414.1" data-end="416.53">Not hitting that goal is what can make your web app</span> <span data-start="416.53" data-end="419.2">feel like low quality or unpolished.</span> <span data-start="419.2" data-end="422.44">Failing to hit a consistent 60 FPS</span> <span data-start="422.44" data-end="425.32">is one of the bigger factors in why web apps feel worse</span> <span data-start="425.32" data-end="427.81">than their comparable native app.</span> <span data-start="427.81" data-end="430.38">So if you want to ship 60 frames a second,</span> <span data-start="430.38" data-end="432.51">the entire system can spend, at most,</span> <span data-start="432.51" data-end="437.67">16.6 milliseconds to finish each frame, start to end.</span> <span data-start="437.67" data-end="439.63">Most of these tasks are run by the browser.</span> <span data-start="439.63" data-end="442.05">And so you really don't have any direct control</span> <span data-start="442.05" data-end="443.01">over the duration.</span> <span data-start="443.01" data-end="445.11">The only thing where you have direct control</span> <span data-start="445.11" data-end="448.92">over the duration is your JavaScript, the amount of code</span> <span data-start="448.92" data-end="451.09">that you run on the phone.</span> </p>
<p><span data-start="451.09" data-end="453.57">But it's not just that, not just the JavaScript,</span> <span data-start="453.57" data-end="458.01">but also the amount of work that the JavaScript causes.</span> <span data-start="458.01" data-end="461.85">So it's really hard to tell how much work a piece of JavaScript</span> <span data-start="461.85" data-end="462.78">will cost.</span> <span data-start="462.78" data-end="466.23">And that's why it's so important to test on real devices.</span> <span data-start="466.23" data-end="468.45">And here you might realize the device</span> <span data-start="468.45" data-end="470.19">that you choose for testing will have</span> <span data-start="470.19" data-end="474.07">a massive impact on the results that you get in your testing.</span> </p>
<p><span data-start="474.07" data-end="476.83">So while you test on your iPhone or even your laptop,</span> <span data-start="476.83" data-end="477.88">it might look like this.</span> <span data-start="477.88" data-end="479.43">And you feel, oh, that's fine.</span> <span data-start="479.43" data-end="481.86">But then you check on a Moto G4, and it</span> <span data-start="481.86" data-end="486.09">looks like this, which is still fine, but definitely less</span> <span data-start="486.09" data-end="486.9">headroom.</span> <span data-start="486.9" data-end="490.02">And then you run your app on, say, a feature phone or a Nokia</span> <span data-start="490.02" data-end="494.62">2, and suddenly, you're way over your budget.</span> <span data-start="494.62" data-end="496.55">And again, the budget was 16 milliseconds</span> <span data-start="496.55" data-end="498.8">because that's how much time you have</span> <span data-start="498.8" data-end="502.5">when you want to fit 60 frames into one second.</span> <span data-start="502.5" data-end="506.03">But recently, Google brought out the Pixel 4,</span> <span data-start="506.03" data-end="507.62">which has a 90 hertz screen.</span> </p>
<p><span data-start="507.62" data-end="511.363">So on that device, you only have 11 milliseconds per frame.</span> <span data-start="511.363" data-end="512.78">On that note, two years ago, Apple</span> <span data-start="512.78" data-end="515.33">published the second generation of the iPad Pro,</span> <span data-start="515.33" data-end="517.22">which has a 120 hertz screen.</span> <span data-start="517.22" data-end="521.15">So that means that, yeah, you only have 8 milliseconds.</span> </p>
<p><span data-start="521.15" data-end="524.3">We barely make it through our [INAUDIBLE] styles here.</span> <span data-start="524.3" data-end="528.08">Did I mention that there are desktop screen is 144 hertz?</span> <span data-start="528.08" data-end="529.717">Yeah, we're in trouble here.</span> <span data-start="529.717" data-end="531.55">So on the one hand, we have hyperconstrained</span> <span data-start="531.55" data-end="534.37">devices that are not getting faster, but cheaper.</span> </p>
<p><span data-start="534.37" data-end="536.48">And at the same time, also wealthy Westerners</span> <span data-start="536.48" data-end="539.87">getting the flagship phones get faster hardware, but also</span> <span data-start="539.87" data-end="542.94">screens that want to ship more frames per second.</span> <span data-start="542.94" data-end="545.18">So both of these developments leave us</span> <span data-start="545.18" data-end="548.12">with less and less time to spend on the main thread</span> <span data-start="548.12" data-end="549.27">for our code.</span> <span data-start="549.27" data-end="551.21">We can't just keep putting code there</span> <span data-start="551.21" data-end="553.668">without thinking about it.</span> <span data-start="553.668" data-end="555.21">So really what I'm trying to say here</span> <span data-start="555.21" data-end="558.42">is, if we want to follow the RAIL guidelines,</span> <span data-start="558.42" data-end="560.67">we are imposing budgets on ourselves</span> <span data-start="560.67" data-end="563.7">based on how an app feels when a user uses it —  so basically</span> <span data-start="563.7" data-end="566.08">based on human psychology.</span> <span data-start="566.08" data-end="568.59">And that is completely independent of the device</span> <span data-start="568.59" data-end="570.99">that the user holds in their hands.</span> </p>
<p><span data-start="570.99" data-end="572.91">And then we write some code, and we throw it</span> <span data-start="572.91" data-end="574.74">all at the main thread.</span> <span data-start="574.74" data-end="578.55">And every piece of code we run consumes a piece of our budget</span> <span data-start="578.55" data-end="579.99">from the main thread.</span> <span data-start="579.99" data-end="584.01">But how much is actually dependent on the hardware</span> <span data-start="584.01" data-end="587.85">and, as such, is completely device dependent.</span> <span data-start="587.85" data-end="590.61">So we are setting ourselves up for failure here.</span> <span data-start="590.61" data-end="592.38">We have no control over the environment</span> <span data-start="592.38" data-end="593.64">that our app will run in.</span> <span data-start="593.64" data-end="597.52">So the question is the main thread</span> <span data-start="597.52" data-end="599.55">is completely unpredictable.</span> <span data-start="599.55" data-end="601.96">What takes two milliseconds on a modern flagship phone</span> <span data-start="601.96" data-end="605.06">might take 20 milliseconds on the next low-end phone.</span> </p>
<p><span data-start="605.06" data-end="608.74">How can we escape this unpredictability?</span> <span data-start="608.74" data-end="611.77">Looking at native platforms like Android or iOS,</span> <span data-start="611.77" data-end="613.93">they provide threads and patterns</span> <span data-start="613.93" data-end="616.81">around and on top of threads and have done so</span> <span data-start="616.81" data-end="618.43">for a very, very long time.</span> <span data-start="618.43" data-end="620.07">Basic threading often looks like this.</span> <span data-start="620.07" data-end="620.82">This is a snippet.</span> <span data-start="620.82" data-end="624.43">It would work like this in Java or C#.</span> <span data-start="624.43" data-end="626.29">But most other languages are similar</span> <span data-start="626.29" data-end="628.3">where you just give a thread of function,</span> <span data-start="628.3" data-end="630.85">and now that function will run in parallel</span> <span data-start="630.85" data-end="632.32">to the rest of your program.</span> <span data-start="632.32" data-end="635.033">You can access the same variables from both threads.</span> <span data-start="635.033" data-end="636.95">And to make sure there are no race conditions,</span> <span data-start="636.95" data-end="639.79">you can use [INAUDIBLE] to synchronize access</span> <span data-start="639.79" data-end="641.5">to these shared resources.</span> </p>
<p><span data-start="641.5" data-end="644.3">In terms of higher level abstractions, iOS, for example,</span> <span data-start="644.3" data-end="647.23">has Grand Central Dispatch, a scheduling service, which</span> <span data-start="647.23" data-end="649.27">allows you to think in tasks.</span> <span data-start="649.27" data-end="652.69">Here's an example from Swift and how you use Grand Central</span> <span data-start="652.69" data-end="653.92">Dispatch in Swift.</span> <span data-start="653.92" data-end="656.47">In this case, you want to update a label in our UI</span> <span data-start="656.47" data-end="657.46">with a new text.</span> </p>
<p><span data-start="657.46" data-end="659.29">And to know what goes into the label,</span> <span data-start="659.29" data-end="662.09">let's say we have to hit the database or the network.</span> <span data-start="662.09" data-end="664.57">So we schedule the loadArticleText function that</span> <span data-start="664.57" data-end="666.31">does this in the background.</span> <span data-start="666.31" data-end="668.17">So it runs independent of the main thread</span> <span data-start="668.17" data-end="669.7">and with a lower priority.</span> <span data-start="669.7" data-end="672.27">And once it is done, it will schedule another main thread</span> <span data-start="672.27" data-end="672.77">task.</span> <span data-start="672.77" data-end="675.79">It actually does the assignment to the label</span> <span data-start="675.79" data-end="679.19">because only the main thread can access UI elements.</span> <span data-start="679.19" data-end="682.99">And this is what I would love to have for the web.</span> <span data-start="682.99" data-end="685.33">However, JavaScript, as a language,</span> <span data-start="685.33" data-end="687.82">is incapable of providing these kind of threads.</span> <span data-start="687.82" data-end="691.78">JavaScript was designed around the concept of a single thread.</span> <span data-start="691.78" data-end="694.8">And we can't just add threads and shared memory</span> <span data-start="694.8" data-end="697.84">to JavaScript, because it would actually break everything</span> <span data-start="697.84" data-end="699.46">and set it on fire.</span> </p>
<p><span data-start="699.46" data-end="703">So instead, we have to isolate the concept to a dedicated</span> <span data-start="703" data-end="707.74">type, like SharedArrayBuffer, and provide parallelism</span> <span data-start="707.74" data-end="709.4">through workers.</span> <span data-start="709.4" data-end="711.86">Now, SharedArrayBuffers are fairly new,</span> <span data-start="711.86" data-end="713.56">but workers are actually not new at all.</span> <span data-start="713.56" data-end="716.56">They have been around since roughly 2007</span> <span data-start="716.56" data-end="720.01">and had wide support in every browser since 2012.</span> </p>
<p><span data-start="720.01" data-end="721.78">And just to make it clear, web workers</span> <span data-start="721.78" data-end="724.54">are something very different from service workers</span> <span data-start="724.54" data-end="725.56">and worklets.</span> <span data-start="725.56" data-end="728.17">They share some characteristics, but be</span> <span data-start="728.17" data-end="729.52">careful to not conflate them.</span> <span data-start="729.52" data-end="734.692">In the context of this talk, I'm only talking about web workers.</span> <span data-start="734.692" data-end="736.15">So workers, in case you don't know,</span> <span data-start="736.15" data-end="740.02">are a bit like as if I opened the browser twice,</span> <span data-start="740.02" data-end="742.51">but one of them is kind of headless.</span> <span data-start="742.51" data-end="746.5">So they're completely isolated, no variables can be shared,</span> <span data-start="746.5" data-end="749.04">and they run in parallel.</span> <span data-start="749.04" data-end="750.79">Now, in terms of code, you create a worker</span> <span data-start="750.79" data-end="754">by passing a file to the worker constructor.</span> </p>
<p><span data-start="754" data-end="757.48">And that will basically spin up the isolated worker</span> <span data-start="757.48" data-end="758.48">that you can — </span> <span data-start="758.48" data-end="760.63">the second browser without — </span> <span data-start="760.63" data-end="761.8">the headless version.</span> <span data-start="761.8" data-end="764.92">You can still communicate with it by sending messages.</span> <span data-start="764.92" data-end="766.81">And the value of the message you want to send</span> <span data-start="766.81" data-end="769.03">is the parameter for this postMessage call.</span> <span data-start="769.03" data-end="772.12">That value will now be copied to the worker.</span> <span data-start="772.12" data-end="775.6">And to receive it, you must register a handler</span> <span data-start="775.6" data-end="777.31">for the message event.</span> <span data-start="777.31" data-end="779.77">The value can then be read on the dot data</span> <span data-start="779.77" data-end="781.3">property on the event.</span> <span data-start="781.3" data-end="782.95">And the worker is, of course, allowed</span> <span data-start="782.95" data-end="785.41">to send a message back to the main thread</span> <span data-start="785.41" data-end="786.655">with the exact same API.</span> </p>
<p><span data-start="786.655" data-end="788.53">And you receive it on the main thread, again,</span> <span data-start="788.53" data-end="790.69">with the exact same message event header.</span> <span data-start="790.69" data-end="791.77">And that's all you got.</span> <span data-start="791.77" data-end="794.83">That's all you can use when you want to use workers.</span> <span data-start="794.83" data-end="798.13">Now, that might seem kind of OK.</span> <span data-start="798.13" data-end="800.35">So far, workers have historically only</span> <span data-start="800.35" data-end="803.71">been used for moving a piece of heavy work</span> <span data-start="803.71" data-end="805.9">away from the main thread.</span> </p>
<p><span data-start="805.9" data-end="808.36">And the worker only exists for the duration</span> <span data-start="808.36" data-end="811.19">of the main thread, for example, in Skrooge.</span> <span data-start="811.19" data-end="812.53">We did exactly this.</span> <span data-start="812.53" data-end="813.41">We spin up a worker.</span> <span data-start="813.41" data-end="816.37">We load our WebAssembly-fied image codecs.</span> <span data-start="816.37" data-end="817.833">We send over a bitmap.</span> <span data-start="817.833" data-end="819.25">WebAssembly does its thing, and it</span> <span data-start="819.25" data-end="821.74">responds with the encoded image, and then</span> <span data-start="821.74" data-end="822.74">we terminate the worker.</span> <span data-start="822.74" data-end="823.573">We are done with it.</span> <span data-start="823.573" data-end="826.48">It's just a one-off worker for a single task, a single purpose</span> <span data-start="826.48" data-end="828.26">worker, if you will.</span> </p>
<p><span data-start="828.26" data-end="830.59">However, things will get unwieldy quite</span> <span data-start="830.59" data-end="834.01">quickly when you want to offer more than one operation</span> <span data-start="834.01" data-end="834.79">in a worker.</span> <span data-start="834.79" data-end="837.7">To get back to our previous example, what if, in addition</span> <span data-start="837.7" data-end="841.13">to addition, we also wanted to add subtraction?</span> </p>
<p><span data-start="841.13" data-end="843.37">Now we have to not only encode the parameters</span> <span data-start="843.37" data-end="845.65">into the message, but also the operation</span> <span data-start="845.65" data-end="848.47">that the worker is supposed to execute.</span> <span data-start="848.47" data-end="852.51">And that has implications for the complexity of the worker</span> <span data-start="852.51" data-end="855.24">because now we need to not only introspect the operation,</span> <span data-start="855.24" data-end="858">but also dispatch the parameters to the right piece of code that</span> <span data-start="858" data-end="859.66">actually does that.</span> </p>
<p><span data-start="859.66" data-end="861.69">And now what if, while the first operation</span> <span data-start="861.69" data-end="864.056">is being calculated in the worker, the main thread</span> <span data-start="864.056" data-end="865.14">sends another operation?</span> <span data-start="865.14" data-end="868.44">How do we know which response maps to which original request?</span> </p>
<p><span data-start="868.44" data-end="870.42">We have to now do bookkeeping with IDs.</span> <span data-start="870.42" data-end="873.24">And it is not great.</span> <span data-start="873.24" data-end="875.693">If you've ever worked with threads in any other language,</span> <span data-start="875.693" data-end="877.11">coming to Java [INAUDIBLE] workers</span> <span data-start="877.11" data-end="880.85">is going to feel really bad and feel very complicated.</span> </p>
<p><span data-start="880.85" data-end="882.78">And I think that's one of the main reasons why</span> <span data-start="882.78" data-end="885.42">workers haven't seen a lot of adoption on the web</span> <span data-start="885.42" data-end="886.83">to this day.</span> <span data-start="886.83" data-end="888.81">I actually believe that postMessage</span> <span data-start="888.81" data-end="890.73">has been a bit misunderstood.</span> <span data-start="890.73" data-end="892.98">And it could actually be a strength</span> <span data-start="892.98" data-end="896.04">if you build something around that message-passing pattern.</span> <span data-start="896.04" data-end="899.187">For example, the actor model is a perfect fit here.</span> <span data-start="899.187" data-end="901.02">And Paul Lewis and I talked about this here,</span> <span data-start="901.02" data-end="902.56">at CDS, last year.</span> </p>
<p><span data-start="902.56" data-end="904.96">And you should check that talk out if you're interested.</span> <span data-start="904.96" data-end="906.66">But since we already talked about it last year,</span> <span data-start="906.66" data-end="908.827">I want to talk about a different approach this year.</span> <span data-start="908.827" data-end="912.08">And this is with libraries like Comlink.</span> <span data-start="912.08" data-end="915.568">Now Comlink is a library that removes the conceptual overhead</span> <span data-start="915.568" data-end="916.86">of communication with a worker.</span> <span data-start="916.86" data-end="919.68">Its goal is to let you use workers without actually</span> <span data-start="919.68" data-end="921.25">thinking about them.</span> <span data-start="921.25" data-end="924.18">So through some convoluted proxy magic,</span> <span data-start="924.18" data-end="926.01">Comlink allows you to share variables</span> <span data-start="926.01" data-end="928.02">between the worker and the main thread</span> <span data-start="928.02" data-end="930.21">almost like the normal programming</span> <span data-start="930.21" data-end="932.01">languages that are out there.</span> <span data-start="932.01" data-end="935.61">So for example, I can import Comlink into my worker,</span> <span data-start="935.61" data-end="937.57">and I can define a set of functions</span> <span data-start="937.57" data-end="940.59">that I want to expose to the main thread.</span> </p>
<p><span data-start="940.59" data-end="942.3">And then, on the main thread, I can also</span> <span data-start="942.3" data-end="944.85">import Comlink and wrap the worker</span> <span data-start="944.85" data-end="948">and get access to these exposed functions.</span> <span data-start="948" data-end="950.16">The API variable here, on the main thread,</span> <span data-start="950.16" data-end="953.4">will behave exactly the same as the one in the worker,</span> <span data-start="953.4" data-end="956.25">except that every function will now not return a value,</span> <span data-start="956.25" data-end="959.778">but a promise for that value.</span> <span data-start="959.778" data-end="962.19">And in combination with async await,</span> <span data-start="962.19" data-end="965.22">it barely makes a difference syntactically, though.</span> <span data-start="965.22" data-end="967.83">And so this is exactly what we used in PROXX</span> <span data-start="967.83" data-end="970.44">to move parts of our game into a worker.</span> <span data-start="970.44" data-end="972.03">But now the next question is, which</span> <span data-start="972.03" data-end="974.31">parts did we actually move?</span> <span data-start="974.31" data-end="976.89">Because one of the limitations that many people point</span> <span data-start="976.89" data-end="981">out is that workers do not have access to the DOM.</span> </p>
<p><span data-start="981" data-end="984.78">And actually, they can't access a whole bunch of APIs.</span> <span data-start="984.78" data-end="988.29">So depending on whether your app relies on access</span> <span data-start="988.29" data-end="990.75">to some of these APIs, you might not</span> <span data-start="990.75" data-end="994.06">be able to run most of your app into worker.</span> <span data-start="994.06" data-end="996.63">So really, the title of this talk</span> <span data-start="996.63" data-end="1000.32">should be "The main thread is overworked and underpaid — </span> <span data-start="1000.32" data-end="1002.75">the name is bad, too, and yet, sometimes, you</span> <span data-start="1002.75" data-end="1004.85">don't even have a choice."</span> <span data-start="1004.85" data-end="1007.65">At that point, you have to chunk your code</span> <span data-start="1007.65" data-end="1010.73">that's running on the main thread to make sure with APIs</span> <span data-start="1010.73" data-end="1013.92">isInputPending that Eddie and I talked about.</span> </p>
<p><span data-start="1013.92" data-end="1015.98">But again, it's really hard to know</span> <span data-start="1015.98" data-end="1018.68">how small the chunks should be because devices</span> <span data-start="1018.68" data-end="1021.83">are so widespread in their performance metrics.</span> <span data-start="1021.83" data-end="1025.099">And also just because we cannot move everything doesn't mean we</span> <span data-start="1025.099" data-end="1027.41">should abandon the entire effort altogether.</span> <span data-start="1027.41" data-end="1030.23">Every small piece of code that we can move</span> <span data-start="1030.23" data-end="1033.98">buys a little bit more headroom to make room for the stuff</span> <span data-start="1033.98" data-end="1037.4">that we have to run on the main thread, like access to the DOM</span> <span data-start="1037.4" data-end="1039.833">because the DOM is not available in a worker</span> <span data-start="1039.833" data-end="1041.75">and, therefore, it's bound to the main thread.</span> <span data-start="1041.75" data-end="1044.72">And I'm pretty sure all our apps have UIs.</span> <span data-start="1044.72" data-end="1046.79">And again, this is not an alien concept.</span> <span data-start="1046.79" data-end="1049.94">Both Android and iOS do not let you</span> <span data-start="1049.94" data-end="1053.4">access your UI from anywhere but the main thread.</span> </p>
<p><span data-start="1053.4" data-end="1056.18">So let's go back to that Swift example that we had earlier.</span> <span data-start="1056.18" data-end="1057.74">If we just go to the main thread just</span> <span data-start="1057.74" data-end="1061.64">to change the text of a label, if we were to skip that step,</span> <span data-start="1061.64" data-end="1062.75">the app would crash.</span> <span data-start="1062.75" data-end="1063.95">They actively enforce it.</span> <span data-start="1063.95" data-end="1065.85">You cannot do that.</span> <span data-start="1065.85" data-end="1069.24">You cannot access your UI from anywhere but the main thread,</span> <span data-start="1069.24" data-end="1071.78">which is actually why both iOS and Android often call</span> <span data-start="1071.78" data-end="1073.585">their main thread the UI thread.</span> <span data-start="1073.585" data-end="1075.71">And I find that really helpful because it tells you</span> <span data-start="1075.71" data-end="1079.392">what should be there and what should not be there.</span> <span data-start="1079.392" data-end="1080.85">One of the struggles I often see is</span> <span data-start="1080.85" data-end="1083.31">that current UI frameworks on the web</span> <span data-start="1083.31" data-end="1085.38">are the center of your universe.</span> </p>
<p><span data-start="1085.38" data-end="1087.6">They are the entry point to your codes.</span> <span data-start="1087.6" data-end="1090.843">And they are the overall orchestrator of everything.</span> <span data-start="1090.843" data-end="1092.76">Anything else that you want to use in your app</span> <span data-start="1092.76" data-end="1096.138">ends up being a component within that UI framework.</span> <span data-start="1096.138" data-end="1097.68">And again, it's not something that we</span> <span data-start="1097.68" data-end="1099.72">can blame UI frameworks for.</span> <span data-start="1099.72" data-end="1102.54">This is how it's been on the web since its inception.</span> <span data-start="1102.54" data-end="1106.35">that has been a best practice or even the only choice.</span> <span data-start="1106.35" data-end="1108.74">UI frameworks think in UI components</span> <span data-start="1108.74" data-end="1111.72">and are inherently tied to the UI and the DOM.</span> <span data-start="1111.72" data-end="1115.38">And as a result, workers are not very useful from a UI</span> <span data-start="1115.38" data-end="1117.24">framework's perspective.</span> <span data-start="1117.24" data-end="1119.22">And I think we can move forward here</span> <span data-start="1119.22" data-end="1121.36">by separating these concerns.</span> <span data-start="1121.36" data-end="1125.37">I think we should try to use the UI thread for UI work only.</span> <span data-start="1125.37" data-end="1127.57">And UI frameworks do UI work.</span> </p>
<p><span data-start="1127.57" data-end="1128.8">They are allowed on the UI.</span> <span data-start="1128.8" data-end="1129.66">They belong there.</span> <span data-start="1129.66" data-end="1133.41">But many other things can actually go somewhere else.</span> <span data-start="1133.41" data-end="1136.77">And that's the mantra that we've followed for PROXX.</span> <span data-start="1136.77" data-end="1139.83">We actually distinguished between a visual state and game</span> <span data-start="1139.83" data-end="1141.21">state.</span> <span data-start="1141.21" data-end="1143.82">Or to categorize it another way, we</span> <span data-start="1143.82" data-end="1146.943">had the main thread, which runs our two rendering engines.</span> <span data-start="1146.943" data-end="1148.86">Yes, we have two rendering engines —  one using</span> <span data-start="1148.86" data-end="1152.34">WebGL and one using Canvas 2D, because not all phones actually</span> <span data-start="1152.34" data-end="1154.92">have WebGL like these feature phones.</span> <span data-start="1154.92" data-end="1158.31">And this code's handled states for animations and transitions</span> <span data-start="1158.31" data-end="1159.16">and small things.</span> </p>
<p><span data-start="1159.16" data-end="1160.91">So we want to be really snappy in response</span> <span data-start="1160.91" data-end="1164.26">if the code is small and really, really fast.</span> <span data-start="1164.26" data-end="1167.73">The worker runs the game logic, and it's purely computational.</span> <span data-start="1167.73" data-end="1170.4">This code is longer and can actually run longer or even</span> <span data-start="1170.4" data-end="1172.76">in a blocking fashion.</span> <span data-start="1172.76" data-end="1175.54">So note there are two kinds of state, UI state and the app</span> <span data-start="1175.54" data-end="1176.04">state.</span> <span data-start="1176.04" data-end="1178.4">The separation has proved quite useful to use,</span> <span data-start="1178.4" data-end="1180.26">but it's somewhat of a change in a mindset.</span> </p>
<p><span data-start="1183.19" data-end="1186.41">Now, this might sound familiar to some of you</span> <span data-start="1186.41" data-end="1190.14">because what we're doing here is pretty much use something that</span> <span data-start="1190.14" data-end="1193.232">is very similar to the Flux pattern, as in Flux Redux.</span> <span data-start="1193.232" data-end="1195.19">And I found this realization really interesting</span> <span data-start="1195.19" data-end="1199.87">because, to me, it means that many apps that use Flux or Flux</span> <span data-start="1199.87" data-end="1203.11">Redux might actually have a pretty easy time to migrate</span> <span data-start="1203.11" data-end="1205.278">to an off-the-main-thread architecture.</span> <span data-start="1205.278" data-end="1207.82">In case you don't know it, this is what the Flux architecture</span> <span data-start="1207.82" data-end="1208.57">looks like.</span> <span data-start="1208.57" data-end="1212.32">It is implied that only the view is supposed to do the UI work.</span> <span data-start="1212.32" data-end="1216.01">And as such, it should run on the main thread.</span> <span data-start="1216.01" data-end="1217.51">Then the UI emits actions.</span> <span data-start="1217.51" data-end="1219.52">The actions are received by a dispatcher.</span> <span data-start="1219.52" data-end="1221.078">And the dispatcher then kicks off</span> <span data-start="1221.078" data-end="1223.12">the functions that manipulate the state according</span> <span data-start="1223.12" data-end="1223.96">to the action.</span> </p>
<p><span data-start="1223.96" data-end="1228.1">And the new state gets stored in, well, the store.</span> <span data-start="1228.1" data-end="1229.45">And this is the important part.</span> <span data-start="1229.45" data-end="1233.17">All of that can run off main thread environment</span> <span data-start="1233.17" data-end="1235.57">or, more specifically, in a worker.</span> <span data-start="1235.57" data-end="1238.18">Now, no matter how much processing the dispatcher</span> <span data-start="1238.18" data-end="1240.85">has to do, it does not lock the main thread.</span> <span data-start="1240.85" data-end="1242.35">It could even run a while True loop.</span> <span data-start="1242.35" data-end="1244.06">The UI would stay responsive.</span> </p>
<p><span data-start="1244.06" data-end="1246.05">The user can keep interacting.</span> <span data-start="1246.05" data-end="1249.43">So if you use Redux or any other form of Flux pattern,</span> <span data-start="1249.43" data-end="1252.46">I wrote a blog post on how to pull Redux in a worker, which</span> <span data-start="1252.46" data-end="1254.61">might be of interest to you.</span> <span data-start="1254.61" data-end="1258.04">Now, if you want to adopt an off-main-thread architecture,</span> <span data-start="1258.04" data-end="1261.43">I want you to be very aware that off-main-thread architecture</span> <span data-start="1261.43" data-end="1263.65">will not make your app faster.</span> </p>
<p><span data-start="1263.65" data-end="1265.36">It will make it more reliable.</span> <span data-start="1265.36" data-end="1268.42">Because we are really just moving the same amount of work</span> <span data-start="1268.42" data-end="1269.56">to a different thread.</span> <span data-start="1269.56" data-end="1272.5">The overall amount of work stays the same.</span> </p>
<p><span data-start="1272.5" data-end="1274.27">If anything, it might actually get</span> <span data-start="1274.27" data-end="1277.12">a tiny bit slower because of the additional communication</span> <span data-start="1277.12" data-end="1280">overhead between the worker and the main thread.</span> <span data-start="1280" data-end="1282.07">The difference is that, while the worker is busy</span> <span data-start="1282.07" data-end="1284.41">running whatever logic you have, the main thread</span> <span data-start="1284.41" data-end="1287.45">stays free and available to process user interactions</span> <span data-start="1287.45" data-end="1289.45">and do scrolling and do all these kind of things</span> <span data-start="1289.45" data-end="1291.55">while JavaScript is running.</span> <span data-start="1291.55" data-end="1295">It's often better to make the user wait a little bit longer</span> <span data-start="1295" data-end="1296.71">than to drop a frame.</span> </p>
<p><span data-start="1296.71" data-end="1299.95">The time to drop a frame is on the order of milliseconds.</span> <span data-start="1299.95" data-end="1302.41">The time to make a user wait is on the order</span> <span data-start="1302.41" data-end="1304.33">of hundreds of milliseconds.</span> <span data-start="1304.33" data-end="1307.14">And so adding thread helps to process state change</span> <span data-start="1307.14" data-end="1310.863">is less risky than squeezing more work into the next frame,</span> <span data-start="1310.863" data-end="1312.28">especially when the amount of time</span> <span data-start="1312.28" data-end="1315.82">that you cause on the main thread is so unpredictable.</span> </p>
<p><span data-start="1315.82" data-end="1318.16">Now, of course, off-main-thread can make your app</span> <span data-start="1318.16" data-end="1321.01">faster because phones have multiple cores.</span> <span data-start="1321.01" data-end="1322.39">And with workers, we can make use</span> <span data-start="1322.39" data-end="1324.32">of all these cores in parallel.</span> <span data-start="1324.32" data-end="1326.41">So if your app's logic is parallelizable,</span> <span data-start="1326.41" data-end="1328.19">you should go ahead and reap the benefits.</span> </p>
<p><span data-start="1328.19" data-end="1330.19">However, do keep in mind that, on phones,</span> <span data-start="1330.19" data-end="1333.01">it's only often one or two cores that are actually fast,</span> <span data-start="1333.01" data-end="1335.417">and all the other cores are a lot slower.</span> <span data-start="1335.417" data-end="1337">So it's actually hard to estimate what</span> <span data-start="1337" data-end="1338.44">the benefits are going to be.</span> <span data-start="1338.44" data-end="1341.65">And for this talk, I want to focus on risk reduction</span> <span data-start="1341.65" data-end="1343.45">because I think that's really the key word.</span> <span data-start="1343.45" data-end="1346.81">I see off-main-thread as a means to reduce risk,</span> <span data-start="1346.81" data-end="1350.59">make your app more robust in the face of adverse runtime</span> <span data-start="1350.59" data-end="1351.298">conditions.</span> </p>
<p><span data-start="1351.298" data-end="1352.84">It's not about parallelizable for me.</span> <span data-start="1352.84" data-end="1357.265">It's about improving my microbenchmarks.</span> <span data-start="1357.265" data-end="1361.388">And in PROXX, we actually have a pretty extreme example of this.</span> <span data-start="1361.388" data-end="1362.18">Let's look at this.</span> <span data-start="1362.18" data-end="1364.18">Here we have a version of PROXX where everything</span> <span data-start="1364.18" data-end="1366.02">runs on the main thread.</span> <span data-start="1366.02" data-end="1367.52">No workers are in use.</span> </p>
<p><span data-start="1367.52" data-end="1370.292">And the timer starts when a user taps one of the fields</span> <span data-start="1370.292" data-end="1370.875">on the screen.</span> <span data-start="1370.875" data-end="1372.06">You ready?</span> <span data-start="1372.06" data-end="1372.77">Go.</span> <span data-start="1372.77" data-end="1374.84">The game engine is now figuring out what needs to happen.</span> <span data-start="1374.84" data-end="1376.257">Which fields need to get revealed?</span> <span data-start="1376.257" data-end="1378.53">And during that time, the UI is frozen — </span> <span data-start="1378.53" data-end="1382.65">no animations, no scrolling for six seconds in total.</span> <span data-start="1382.65" data-end="1383.77">That's pretty bad.</span> <span data-start="1383.77" data-end="1385.37">Now let's compare this to the game</span> <span data-start="1385.37" data-end="1389.03">running on the same hardware but with our off-main-thread</span> <span data-start="1389.03" data-end="1390.92">architecture with workers.</span> <span data-start="1390.92" data-end="1391.88">Ready?</span> <span data-start="1391.88" data-end="1392.96">Go.</span> <span data-start="1392.96" data-end="1394.08">We see an animation.</span> <span data-start="1394.08" data-end="1396.49">We see, actually, that the game engine is working.</span> </p>
<p><span data-start="1396.49" data-end="1399.53">And during all this time, the UI is responsive.</span> <span data-start="1399.53" data-end="1402.195">The user can scroll and tap and keep playing.</span> <span data-start="1402.195" data-end="1403.82">Basically, the user is getting feedback</span> <span data-start="1403.82" data-end="1407.045">that something is happening, a very basic UX rule.</span> <span data-start="1407.045" data-end="1408.92">And here's why I say it's an extreme example.</span> </p>
<p><span data-start="1408.92" data-end="1413.22">The game takes almost twice as long to reach the same state.</span> <span data-start="1413.22" data-end="1414.92">Now, that sounds pretty bad, doesn't it?</span> <span data-start="1414.92" data-end="1417.17">But the question is, is this really the number that we</span> <span data-start="1417.17" data-end="1418.64">should be looking at here?</span> <span data-start="1418.64" data-end="1421.55">Is the question how quickly can we get this work done,</span> <span data-start="1421.55" data-end="1425.252">or how can we make the game feel better?</span> <span data-start="1425.252" data-end="1426.71">Let's the measure how long it takes</span> <span data-start="1426.71" data-end="1430.823">for the game to give the user a visual response.</span> <span data-start="1430.823" data-end="1432.24">On the version without workers, we</span> <span data-start="1432.24" data-end="1434.85">saw we had to wait for six seconds for the task to finish.</span> </p>
<p><span data-start="1434.85" data-end="1436.35">And since it was on the main thread,</span> <span data-start="1436.35" data-end="1437.975">the main thread was completely blocked.</span> <span data-start="1437.975" data-end="1439.89">So after six seconds is the first time</span> <span data-start="1439.89" data-end="1442.2">that we actually can cause any change.</span> <span data-start="1442.2" data-end="1444.24">And that's exactly what the number shows.</span> <span data-start="1444.24" data-end="1447.69">When we use workers, we keep the main thread free.</span> <span data-start="1447.69" data-end="1451.53">And we can use that freedom to update the UI while the game</span> <span data-start="1451.53" data-end="1452.28">logic was running.</span> <span data-start="1452.28" data-end="1455.64">So the first update actually happens seven frames</span> <span data-start="1455.64" data-end="1457.98">after we tapped, which is roughly 100 milliseconds,</span> <span data-start="1457.98" data-end="1461.61">and so perfectly in line with our RAIL budget.</span> </p>
<p><span data-start="1461.61" data-end="1463.83">So the question is, is this, it takes twice</span> <span data-start="1463.83" data-end="1465.45">as long, a big deal?</span> <span data-start="1465.45" data-end="1466.95">Yeah, it's a big deal, but it's also</span> <span data-start="1466.95" data-end="1468.6">a very conscious trade-off.</span> <span data-start="1468.6" data-end="1471.15">And it's also important to note the slowdown is not</span> <span data-start="1471.15" data-end="1472.89">because we're using workers.</span> </p>
<p><span data-start="1472.89" data-end="1475.14">It is slower because we are using the freedom</span> <span data-start="1475.14" data-end="1478.17">to ship more frames than the other version, which</span> <span data-start="1478.17" data-end="1480.72">shipped no frames at all.</span> <span data-start="1480.72" data-end="1482.8">And shipping frames on these low-end devices</span> <span data-start="1482.8" data-end="1485.41">is very expensive.</span> <span data-start="1485.41" data-end="1488.34">And it looks very different if you run the exact same code</span> <span data-start="1488.34" data-end="1490.19">on a modern piece of hardware.</span> <span data-start="1490.19" data-end="1491.34">Ready?</span> </p>
<p><span data-start="1491.34" data-end="1492.43">Go.</span> <span data-start="1492.43" data-end="1492.93">That's it.</span> <span data-start="1492.93" data-end="1493.555">You can see it.</span> <span data-start="1493.555" data-end="1494.46">It's pretty fast.</span> <span data-start="1494.46" data-end="1497.76">So we can give the users of hyperconstrained devices</span> <span data-start="1497.76" data-end="1500.46">a better experience without penalizing</span> <span data-start="1500.46" data-end="1504.21">the experience of flagship phone users with the same code base.</span> </p>
<p><span data-start="1504.21" data-end="1508.488">To simplify, really, slower does not always mean worse.</span> <span data-start="1508.488" data-end="1510.78">As an anecdote —  you might have heard this one before — </span> <span data-start="1510.78" data-end="1513.21">Houston airport actually got a lot of complains</span> <span data-start="1513.21" data-end="1516.03">that people were spending too much time waiting</span> <span data-start="1516.03" data-end="1518.28">for their luggage at the belts.</span> <span data-start="1518.28" data-end="1519.405">Customers were complaining.</span> <span data-start="1519.405" data-end="1520.78">And so they could have spent time</span> <span data-start="1520.78" data-end="1522.18">optimizing how quickly they could</span> <span data-start="1522.18" data-end="1524.31">get the luggage from the plane onto the belt.</span> <span data-start="1524.31" data-end="1527.31">But instead, they made the way longer for the customers</span> <span data-start="1527.31" data-end="1530.61">to walk from the plane to the belt.</span> <span data-start="1530.61" data-end="1533.85">So the customers were being kept busy with walking</span> <span data-start="1533.85" data-end="1536.52">and spent, technically, less time waiting.</span> <span data-start="1536.52" data-end="1539.21">They were happier, and they got less complaints.</span> </p>
<p><span data-start="1539.21" data-end="1541.05">And this is kind of what you're doing here.</span> <span data-start="1541.05" data-end="1543.75">We made a task slower to have more freedom</span> <span data-start="1543.75" data-end="1545.7">and to use that freedom to keep our users</span> <span data-start="1545.7" data-end="1548.97">busy with a nice animation and actually with the ability</span> <span data-start="1548.97" data-end="1551.373">to continue playing the game.</span> </p>
<p><span data-start="1551.373" data-end="1553.29">So if you find yourself doing microbenchmarks,</span> <span data-start="1553.29" data-end="1556.5">keep in mind that there might be not so obvious trade-offs,</span> <span data-start="1556.5" data-end="1560.75">and that the numbers game is not always the best game.</span> <span data-start="1560.75" data-end="1563.25">Something I've glossed over so far a little bit in this talk</span> <span data-start="1563.25" data-end="1566.22">is that the value that you send from a worker to a main thread</span> <span data-start="1566.22" data-end="1567.99">needs to be copied.</span> </p>
<p><span data-start="1567.99" data-end="1571.78">And that process is called structured cloning.</span> <span data-start="1571.78" data-end="1574.38">It has been a source of worry for many people evaluating</span> <span data-start="1574.38" data-end="1576.31">workers over time.</span> <span data-start="1576.31" data-end="1577.59">So I ran a benchmark.</span> <span data-start="1577.59" data-end="1579.02">You don't need to look at this graph too much.</span> <span data-start="1579.02" data-end="1580.16">I just put it in here so that I look legit</span> <span data-start="1580.16" data-end="1581.685">when I talk about numbers.</span> <span data-start="1581.685" data-end="1583.56">But what I try to prove here is that the time</span> <span data-start="1583.56" data-end="1586.61">it takes to copy a value from one thread to another</span> <span data-start="1586.61" data-end="1589.4">is dependent on how complex the object is.</span> </p>
<p><span data-start="1589.4" data-end="1591.51">A deeply nested, big object will take</span> <span data-start="1591.51" data-end="1595.415">longer than a long-ish string or a simple array.</span> <span data-start="1595.415" data-end="1597.29">And what it turned out that there is actually</span> <span data-start="1597.29" data-end="1599.65">a simple rule of thumb.</span> <span data-start="1599.65" data-end="1601.35">The amount of time it takes to structure</span> <span data-start="1601.35" data-end="1604.23">clone an object is roughly proportional to the length</span> <span data-start="1604.23" data-end="1606.003">of its JSON representation.</span> </p>
<p><span data-start="1606.003" data-end="1607.92">Now, keep in mind that the number that you get</span> <span data-start="1607.92" data-end="1611.015">is very much device-specific.</span> <span data-start="1611.015" data-end="1612.39">And so I ran some more benchmarks</span> <span data-start="1612.39" data-end="1614.05">to establish a lower bound.</span> <span data-start="1614.05" data-end="1617.95">So I want to look at the results that I got on the Nokia 2.</span> <span data-start="1617.95" data-end="1621.11">The TLDR of this graph is that even on the Nokia</span> <span data-start="1621.11" data-end="1624.857">2, if your raw JSON is under 10 kilobytes,</span> <span data-start="1624.857" data-end="1626.94">you don't have to worry about bursting through any</span> <span data-start="1626.94" data-end="1628.41">of your RAIL budgets.</span> <span data-start="1628.41" data-end="1629.98">This might not be enough.</span> <span data-start="1629.98" data-end="1632.28">The 10 kilobytes might not be enough for every app,</span> <span data-start="1632.28" data-end="1635.52">but you can actually do quite a lot with 10 kilobytes.</span> </p>
<p><span data-start="1635.52" data-end="1637.56">If, however, you are running into problems</span> <span data-start="1637.56" data-end="1639.493">with this postMessage pattern, you</span> <span data-start="1639.493" data-end="1641.91">can look into alternatives like transferring array buffers</span> <span data-start="1641.91" data-end="1643.74">using SharedArrayBuffers in Atomics</span> <span data-start="1643.74" data-end="1645.59">or even look into WebAssembly.</span> <span data-start="1645.59" data-end="1648.58">But I can't fit all of that into the 30 minutes that I have.</span> <span data-start="1648.58" data-end="1650.25">So if your interest is peaked, I also</span> <span data-start="1650.25" data-end="1652.32">have a more detailed blog post on this,</span> <span data-start="1652.32" data-end="1654.39">where I explain the graphs and the methodology,</span> <span data-start="1654.39" data-end="1656.89">but all for these alternative techniques that might help you</span> <span data-start="1656.89" data-end="1661.143">address the performance problems if you actually encounter them.</span> <span data-start="1661.143" data-end="1663.06">So if you want to experiment with workers now,</span> <span data-start="1663.06" data-end="1666.75">you might be wondering what the tooling situation is.</span> </p>
<p><span data-start="1666.75" data-end="1669.6">Because workers are not really mainstream.</span> <span data-start="1669.6" data-end="1673.29">They have been overlooked by most of the tooling</span> <span data-start="1673.29" data-end="1674.76">that we have today.</span> <span data-start="1674.76" data-end="1677.85">Webpack and Rollup, for example, don't support workers out</span> <span data-start="1677.85" data-end="1678.6">of the box.</span> <span data-start="1678.6" data-end="1680.37">To change that, my colleague Jason</span> <span data-start="1680.37" data-end="1683.31">wrote a plug-in that teaches Webpack about workers.</span> <span data-start="1683.31" data-end="1686.183">I wrote a plug-in the teaches Rollup about workers.</span> <span data-start="1686.183" data-end="1688.35">I want to give a big shout out to the parcel people,</span> <span data-start="1688.35" data-end="1691.14">because they actually made workers work out of the box,</span> <span data-start="1691.14" data-end="1693.9">so thumbs-up to them.</span> </p>
<p><span data-start="1693.9" data-end="1699.63">And this was basically my off-main-thread on-the-web</span> <span data-start="1699.63" data-end="1701.255">speed run for you.</span> <span data-start="1701.255" data-end="1702.63">There is much more to talk about.</span> <span data-start="1702.63" data-end="1704.76">There is much more nuance in this topic,</span> <span data-start="1704.76" data-end="1707.43">and it's very explorative at this point.</span> <span data-start="1707.43" data-end="1710.11">So I just want to leave you with this.</span> <span data-start="1710.11" data-end="1713.25">We are experiencing death by 1,000 cuts.</span> <span data-start="1713.25" data-end="1717.6">Our problem is not really that any specific UI library is slow</span> <span data-start="1717.6" data-end="1720.87">or that painting takes too long in one browser.</span> <span data-start="1720.87" data-end="1723.42">It's the accumulation of all of these tasks,</span> <span data-start="1723.42" data-end="1728.08">that we run everything on the UI thread.</span> <span data-start="1728.08" data-end="1730.57">Support hyperconstrained devices.</span> <span data-start="1730.57" data-end="1732.6">It is a matter of inclusivity.</span> </p>
<p><span data-start="1732.6" data-end="1735.12">We need to look beyond the tech bubble that we often live in</span> <span data-start="1735.12" data-end="1737.7">and experience the web as the 50th percentile and probably,</span> <span data-start="1737.7" data-end="1739.92">even better, the 75th percentile.</span> <span data-start="1739.92" data-end="1741.75">Some of our current pages won't even</span> <span data-start="1741.75" data-end="1747.74">load over 3G on a feature phone let alone run in a usable way.</span> <span data-start="1747.74" data-end="1749.54">By embracing off main thread architecture,</span> <span data-start="1749.54" data-end="1752.66">you are moving execution costs to a different thread.</span> <span data-start="1752.66" data-end="1756.54">But you actually also move parsing cost.</span> <span data-start="1756.54" data-end="1759.8">So in turn, it might mean that your UI thread is now</span> <span data-start="1759.8" data-end="1762.93">booting up faster, giving you a better time to first count</span> <span data-start="1762.93" data-end="1766.16">in full paint or maybe even a better time to interactive.</span> </p>
<p><span data-start="1766.16" data-end="1768.52">And so, in turn, you could increase your Lighthouse</span> <span data-start="1768.52" data-end="1769.55">scores — </span> <span data-start="1769.55" data-end="1771.06">just saying.</span> <span data-start="1771.06" data-end="1774.33">And lastly, web workers seem very complicated</span> <span data-start="1774.33" data-end="1779.13">and crazy and scary, but they can be enjoyable,</span> <span data-start="1779.13" data-end="1781.89">either by embracing the communication model</span> <span data-start="1781.89" data-end="1784.2">or through libraries like Comlink.</span> <span data-start="1784.2" data-end="1786.45">And with this, I think, we can actually</span> <span data-start="1786.45" data-end="1789.51">take a big step for the web development ecosystem</span> <span data-start="1789.51" data-end="1792.99">to make our web apps more reliable, but also more usable</span> <span data-start="1792.99" data-end="1794.26">for everyone.</span> </p>
<p><span data-start="1794.26" data-end="1794.91">Thank you.</span> <span data-start="1794.91" data-end="1795.51">[APPLAUSE]</span> <span data-start="1795.51" data-end="1798.86">[MUSIC PLAYING]</span> </p>
</section>
<!DOCTYPE html>

<! — 
Copyright 2018 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
 — >

<html lang="en">
<head>
<meta charset="utf-8">
<meta name="author" content="//google.com">
<meta name="description" content="Chrome Dev Summit">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ipNW6lJHVEs</title>
<link rel="stylesheet" href="css/main.css">
</head>

<body>

<div id="container">

<div id="video"></div>

<iframe class="w-youtube__embed" src="https://www.youtube.com/embed/Ai4aZ9Jbsys" allow="picture-in-picture" allowfullscreen=""></iframe>

<div id="google-translate"></div>

<section>
<span data-start="0">[MUSIC PLAYING]</span> </section>

<section><span data-start="6420"><span class="speaker">Mariko Kosaka</span>: Let's go back to February 1993</span> <span data-start="9840">on www-talk mailing list.</span> </section>

<section><span data-start="13680"><span class="speaker">Jake Archibald</span>: This man, Marc Andreessen,</span> <span data-start="15840">he's the creator of Mosaic, one of the earliest web browsers.</span> <span data-start="19500">He wrote this.</span> <span data-start="21360">"I'd like to propose a new optional HTML tag, IMG."</span> </section>

<section><span data-start="29980"><span class="speaker">Mariko Kosaka</span>: And this man replied, Sir Tim Berners-Lee,</span> <span data-start="32530">he wrote, "Or how about ENTITY, ICON6, SYSTEM, URL, &ICON6."</span> <span data-start="44440">[CHUCKLES]</span> </section>

<section><span data-start="46150"><span class="speaker">Jake Archibald</span>: And Marc replied, "Quick, Tim, look over</span> <span data-start="50060">there."</span> <span data-start="50560">And two months later, Mosaic shipped with the IMG tag.</span> <span data-start="52910">[LAUGHTER]</span> </section>

<section><span data-start="53537"><span class="speaker">Mariko Kosaka</span>: It's really fair to say</span> <span data-start="55120">that IMG has been pretty popular on the web for the past 25</span> <span data-start="58690">years, right?</span> </section>

<section><span data-start="59367"><span class="speaker">Jake Archibald</span>: Yes.</span> </section>

<section><span data-start="60200"><span class="speaker">Mariko Kosaka</span>: In fact, according to HTTP Archive,</span> <span data-start="62283">the average web page loads 650 kilobytes of images.</span> <span data-start="67000">That means it's 52% of page content.</span> </section>

<section><span data-start="69615"><span class="speaker">Jake Archibald</span>: Yeah.</span> <span data-start="70490">And images are less blocking compared</span> <span data-start="72070">to things like CSS and scripts.</span> <span data-start="73750">But they can take bandwidth away from more important things.</span> <span data-start="76720">And of course, if the image is your primary content,</span> <span data-start="79330">loading it quickly is very important.</span> </section>

<section><span data-start="81100"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="81933">Unfortunately, websites throw those bytes away</span> <span data-start="84190">by using really inefficient codec like the one that</span> <span data-start="87070">comes with Photoshop.</span> </section>

<section><span data-start="88142"><span class="speaker">Jake Archibald</span>: And there are better options as well.</span> <span data-start="90350">So this is mozjpeg from Mozilla.</span> <span data-start="93250">But there is also WebP, which is probably</span> <span data-start="96019">supported by the majority of your visitors.</span> <span data-start="97810">As you can see, that WebP has beaten mozjpeg.</span> <span data-start="100544">But both of them have done really, really well</span> <span data-start="102460">compared to Photoshop's JPEG encoder.</span> </section>

<section><span data-start="105097"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="105930">But except you can't really see it.</span> <span data-start="111000">All you can see is some text and numbers.</span> <span data-start="113050">And these [? come-online ?] tools are great for batch</span> <span data-start="116410">processing and automating your build process and everything.</span> <span data-start="119110">But when you are trying to build a site</span> <span data-start="121390">and trying to choose something, it's</span> <span data-start="122950">really not a good experience to change the option.</span> <span data-start="126400">Because you can't really see the effects of the image while</span> <span data-start="129400">you are doing it.</span> <span data-start="130660">So a lot of innovative, small compressions</span> <span data-start="134380">are hidden behind these texts.</span> </section>

<section><span data-start="136355"><span class="speaker">Jake Archibald</span>: Yeah.</span> <span data-start="137230">And this winds me up every time I see a new image</span> <span data-start="139210">format come out.</span> <span data-start="139930">Because you get these really bold</span> <span data-start="141430">claims in a few sample images.</span> <span data-start="143380">And I'm left feeling, I don't believe you.</span> <span data-start="146090">I don't believe you unless I can try it</span> <span data-start="147970">in an easy way using my own images, not</span> <span data-start="149770">cherry-picked examples.</span> <span data-start="151000">So we thought, let's make image compression easy</span> <span data-start="153370">using the world's most accessible GUI, the web.</span> </section>

<section><span data-start="155897"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="156730">So that's what we did.</span> <span data-start="158400">I'm really excited for this slide.</span> <span data-start="160650">Because I get to do this announcements of the product</span> <span data-start="163560">thing.</span> <span data-start="164170">Well, here we go.</span> <span data-start="165280">Today, we are excited to announce new progressive web</span> <span data-start="169900">app, Squoosh.</span> </section>

<section><span data-start="171450"><span class="speaker">Jake Archibald</span>: Yay.</span> <span data-start="172480">OK, fair enough.</span> </section>

<section><span data-start="173570"><span class="speaker">Mariko Kosaka</span>: Did you like that animation?</span> </section>

<section><span data-start="174300"><span class="speaker">Jake Archibald</span>: It was a beautiful animation.</span> <span data-start="175720">Well done.</span> </section>

<section><span data-start="176280"><span class="speaker">Mariko Kosaka</span>: Thank you.</span> </section>

<section><span data-start="176620"><span class="speaker">Jake Archibald</span>: So now the most terrifying part</span> <span data-start="178578">of any presentation, we are going to give a live demo a go.</span> <span data-start="181930">And with the big web quiz failing earlier,</span> <span data-start="184910">luck isn't on our side.</span> <span data-start="186160">Actually, so with the big web quiz stuff,</span> <span data-start="189040">I had noticed some of the answers changing</span> <span data-start="191200">from underneath me as I was correcting them and editing</span> <span data-start="194470">them yesterday.</span> <span data-start="195340">And when that happened, I thought, well,</span> <span data-start="198100">what could have happened here?</span> <span data-start="199720">Could Surma have coded it wrong?</span> <span data-start="201970">Or am I so jet lagged I don't really know what's going on?</span> <span data-start="204780">And I went for that one.</span> <span data-start="205940">I just didn't believe Surma could have done it wrong.</span> <span data-start="207940">OK, are you ready to go?</span> </section>

<section><span data-start="208840"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> </section>

<section><span data-start="209673"><span class="speaker">Jake Archibald</span>: OK.</span> <span data-start="211404">It's going to be fine.</span> <span data-start="212320">So this is Squoosh.</span> <span data-start="213530">This is squoosh.app.</span> <span data-start="214600">So all we need now is an image to compress.</span> <span data-start="216940">And there are some example ones along the bottom here.</span> <span data-start="220300">But let's pick a real-world example.</span> <span data-start="222520">I'm going to go to the Google I/O website.</span> <span data-start="224319">This is the one from this year.</span> <span data-start="225610">Now that header image there is a massive 1.7 megabytes.</span> <span data-start="230940">And that is a large portion of the page weight here.</span> <span data-start="233680">So I'm going to save that image, and we're</span> <span data-start="235720">going to drag it into Squoosh.</span> <span data-start="237400">With Squoosh, it supports the file picker.</span> <span data-start="239390">It supports copy and paste.</span> <span data-start="241474">In this case, we're just going to use drag and drop.</span> <span data-start="243640">There we go.</span> <span data-start="244481">So on the left-hand side here, we've</span> <span data-start="245980">got the original 1.7 megabyte image.</span> <span data-start="247820">And on the right-hand side, we've got mozjpeg.</span> <span data-start="250760">As you can see straight away, mozjpeg</span> <span data-start="252520">has taken it from 1.7 megabytes to 500k.</span> <span data-start="256089">That's huge.</span> <span data-start="257279">And to my eyes, I can't really see</span> <span data-start="259269">a difference between the two.</span> <span data-start="261850">If we zoom right in to the folks on the screen here,</span> <span data-start="265000">we can start to see the difference.</span> <span data-start="267370">If we drag from side to side —  there</span> <span data-start="268870">you go —  slight difference.</span> <span data-start="270694">But it's not going to be displayed</span> <span data-start="272110">like this on the website.</span> <span data-start="273151">It's displayed zoomed out, and you can't see a difference.</span> <span data-start="275650">All this is a —  this kind of interface,</span> <span data-start="277350">this works with touch events and stuff as well.</span> <span data-start="280492">You can touch the screen and do it.</span> <span data-start="281950">So it works great on a Chromebook.</span> <span data-start="283570">I was paid to say that, but it is, nonetheless, true.</span> <span data-start="286610">[LAUGHTER]</span> <span data-start="288900">But because it's displayed for these — </span> <span data-start="290500">it's optimized for high-resolution screens,</span> <span data-start="292660">this big image, well, we can tweak the settings</span> <span data-start="295090">based on that.</span> <span data-start="295760">So we're going to bring the quality down to 44, obviously,</span> <span data-start="299920">one that we rehearsed.</span> <span data-start="302104">And that's just because it's going</span> <span data-start="303520">to be resize down like that.</span> <span data-start="305680">And we can't really go lower than 44,</span> <span data-start="307540">because it starts picking up banding issues, especially</span> <span data-start="310160">around the sky bit there.</span> <span data-start="311770">But we've really dropped the file size.</span> <span data-start="313620">It's almost another 200k gone.</span> <span data-start="315850">Now, lossy formats, they work by removing data</span> <span data-start="318490">that humans aren't very good at seeing anyway.</span> <span data-start="320950">So for instance, we're more sensitive to changes</span> <span data-start="324100">in brightness than changes in color.</span> <span data-start="326120">So these lossy formats, they'll store color data</span> <span data-start="328630">at a lower resolution than the brightness data.</span> <span data-start="332069">But again, since this is aimed at high-density screens,</span> <span data-start="334360">we can go even lower.</span> <span data-start="335690">So we're going to dive into these advanced settings here.</span> <span data-start="338560">We tried to expose everything that these codecs can do.</span> <span data-start="342820">So there are some scary things here like trellis multipass.</span> <span data-start="346550">What does that do?</span> <span data-start="347600">Well, I have absolutely no idea.</span> <span data-start="349120">But I can check this.</span> <span data-start="350170">I can see the impact of it.</span> <span data-start="351782">It's really cheap for me to try it.</span> <span data-start="353240">I'm not breaking anything.</span> </section>

<section><span data-start="353800"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="353950">The great thing about having UI is that you</span> <span data-start="355750">can see it right here, right?</span> <span data-start="357315">And you can figure that out, like, toggle it.</span> </section>

<section><span data-start="359190"><span class="speaker">Jake Archibald</span>: Yeah.</span> <span data-start="359300">You can start to learn what they do.</span> </section>

<section><span data-start="359850"><span class="speaker">Mariko Kosaka</span>: And if it's [? a come-online ?] tool,</span> <span data-start="360700">you can't really see until you're finished, right?</span> </section>

<section><span data-start="363530"><span class="speaker">Jake Archibald</span>: Absolutely, and one</span> <span data-start="364210">of the options we are going to look at</span> <span data-start="365200">is the auto-subsample chroma.</span> <span data-start="366660">This is the thing that's changing the resolution</span> <span data-start="368660">of the color data.</span> <span data-start="369940">By default, it halves it, but we're going to quarter it.</span> <span data-start="372840">And that's another 20k gone as well.</span> <span data-start="374870">So we've now reduced it by 83% of the original that</span> <span data-start="379450">is on the I/O website.</span> <span data-start="381520">If we zoom right in, it's looking like a bit of a mess.</span> <span data-start="385240">You can really see the difference there.</span> <span data-start="386990">But again, zoomed out, which is how it's displayed on the site,</span> <span data-start="390310">it's really different.</span> <span data-start="391460">It's really difficult to tell the difference.</span> <span data-start="394810">Mozilla have done an amazing job at getting the most out</span> <span data-start="397390">of an old image format like JPEG.</span> <span data-start="399340">But let's compare it to WebP.</span> <span data-start="400610">So on the left-hand side, we're going to switch to WebP.</span> <span data-start="403780">And we'll drop the quality down to 20.</span> <span data-start="406980">WebP is a much more modern image format.</span> <span data-start="409180">It's based on the VP8 video codec.</span> <span data-start="411420">It's supported in Chrome.</span> <span data-start="412840">It's coming to Edge 18, Firefox 65.</span> <span data-start="416230">But straight off now, we'll — </span> <span data-start="417537">we're going to be around about — </span> </section>

<section><span data-start="418870"><span class="speaker">Mariko Kosaka</span>: Sorry.</span> <span data-start="419285">Sorry.</span> <span data-start="419700">[INAUDIBLE]</span> <span data-start="420120">Yes.</span> </section>

<section><span data-start="420290"><span class="speaker">Jake Archibald</span>: There we go — </span> <span data-start="421498">about another 100k less than the JPEG.</span> <span data-start="424070">That's 1/10 of the size of the original.</span> <span data-start="427000">If we zoom into those people on the screen again,</span> <span data-start="429267">we can start to see the difference between the two</span> <span data-start="431350">codecs.</span> <span data-start="432470">JPEG goes for a very blocky look, whereas WebP loses</span> <span data-start="436000">details through smoothing.</span> <span data-start="438090">In fact, the WebP, at this size, kind of</span> <span data-start="440020">looks in some ways worse than the JPEG.</span> <span data-start="442749">I don't know.</span> <span data-start="443290">It's subjective.</span> <span data-start="444064">But that's also because we've been</span> <span data-start="445480">able to drop the quality of the WebP</span> <span data-start="447070">a lot more because it doesn't suffer from those banding</span> <span data-start="449410">issues that we get with JPEG.</span> <span data-start="451480">And again zoomed out, there's barely a difference.</span> <span data-start="454931">So now we've done that, we can download the two images</span> <span data-start="457180">and hopefully send them to the people who on the I/O site</span> <span data-start="459940">because that's 1.4 megabytes saved for every visitor that</span> <span data-start="463540">supports WebP, 1.3 megabytes saved for people</span> <span data-start="466720">who like to support JPEG.</span> <span data-start="469030">So that's lossy compression.</span> <span data-start="471250">But we support lossless compression as well.</span> <span data-start="474180">The Squoosh logo here, this is an SVG.</span> <span data-start="477130">Vector formats are great because they're</span> <span data-start="478810">maximum resolution on any device density, any size.</span> <span data-start="483307">But it's worth looking at how this comes out</span> <span data-start="485140">in a nonvector format.</span> <span data-start="487570">This looks a bit broken.</span> <span data-start="488620">This is because we're using JPEG, which</span> <span data-start="490300">doesn't support transparency.</span> <span data-start="491770">So we'll change to another format.</span> <span data-start="493970">We'll change to OptiPNG, which is an optimized PNG format.</span> <span data-start="499520">Once we do that, it's bigger.</span> <span data-start="501520">It's over twice the size, which is not great.</span> <span data-start="503860">But we can optimize for these kind of codecs.</span> <span data-start="506809">So we're going to reduce the palette.</span> <span data-start="508350">We're going to bring it down to, I don't know, 70 colors.</span> <span data-start="512710">And we can turn off differing because we're happy with just</span> <span data-start="515360">a flat color there.</span> <span data-start="516960">And once we do that, we are now smaller</span> <span data-start="519940">with the PNG versus the SVG.</span> <span data-start="522419">It's just a few K. If we zoom right</span> <span data-start="524590">in, we can start to see, I don't know, very subtle differences.</span> <span data-start="529330">But zoomed out, it's not a big deal at all.</span> <span data-start="533480">But let's throw this at WebP's lossless mode.</span> <span data-start="535370">So we're going to copy the settings</span> <span data-start="536828">from one site to the other so we keep the reduced palette data,</span> <span data-start="540110">switch to WebP, and put it in lossless mode.</span> <span data-start="543590">So WebP's lossless codec, it's kind</span> <span data-start="546500">of like a completely different codec.</span> <span data-start="548079">They should have probably called it something different</span> <span data-start="550370">because it's much more similar to PNG.</span> <span data-start="552574">But now you can see we've cut even more off the file size.</span> <span data-start="554990">We're 34% smaller than what we were with the PNG,</span> <span data-start="559340">with the SVG even.</span> <span data-start="561260">But this is yet another cherry-picked demo.</span> <span data-start="564950">Like, we have scripted this to look good on stage, right?</span> <span data-start="568650">What I am saying to you right now</span> <span data-start="570170">is literally written on this screen, including that,</span> <span data-start="574220">and that, and that, and this.</span> </section>

<section><span data-start="578720"><span class="speaker">Mariko Kosaka</span>: Excuse me.</span> <span data-start="579950">[LAUGHTER]</span> <span data-start="581700">Yeah, well, but all we are saying</span> <span data-start="583550">is that, just don't trust our demo.</span> <span data-start="585140">Just go to our app, throw your own image, and try it out.</span> <span data-start="588860">And see how many bytes you can shave off the image</span> <span data-start="592070">by keeping acceptable quality.</span> <span data-start="594891">So we can go back to the slides now.</span> </section>

<section><span data-start="601604"><span class="speaker">Jake Archibald</span>: OK.</span> <span data-start="602395">So that's the good parts.</span> <span data-start="604360">But Squoosh is still in beta.</span> <span data-start="606240">It isn't finished yet.</span> <span data-start="607300">There are —  there's a few rough edges.</span> <span data-start="609810">And we do want to be honest about that.</span> <span data-start="611500">For instance, right now, if you open it in Firefox,</span> <span data-start="615340">you get this.</span> <span data-start="616389">We're a little bit behind on our browser support.</span> <span data-start="618430">[LAUGHTER]</span> <span data-start="619156">Oh, come on.</span> <span data-start="619844">Look, we've run out of time.</span> <span data-start="621010">We are hoping to fix this.</span> </section>

<section><span data-start="622300"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="622380">We had the big web quiz to build and everything.</span> </section>

<section><span data-start="624050"><span class="speaker">Jake Archibald</span>: We had other things to build.</span> <span data-start="626140">We are joking of course.</span> </section>

<section><span data-start="627300"><span class="speaker">Mariko Kosaka</span>: Joking.</span> </section>

<section><span data-start="628216"><span class="speaker">Jake Archibald</span>: Come on, right?</span> </section>

<section><span data-start="629610"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="630443">As well as being a useful tool —  which we hope that you find it</span> <span data-start="633610">useful too — </span> <span data-start="634750">we wanted to practice what we preach.</span> <span data-start="636790">So we wanted to make the Squoosh to be a great PWA.</span> <span data-start="640360">So Squoosh works in latest version of all modern browsers.</span> <span data-start="646060">[APPLAUSE]</span> <span data-start="648992">Well, this is kind of — </span> </section>

<section><span data-start="649950"><span class="speaker">Jake Archibald</span>: Only Googlers can get a round of applause</span> <span data-start="652090">for just making things work with other browsers.</span> </section>

<section><span data-start="653780"><span class="speaker">Mariko Kosaka</span>: Yes.</span> <span data-start="654571">This is kind of sad that we got applause for this.</span> </section>

<section><span data-start="657047"><span class="speaker">Jake Archibald</span>: Yes.</span> <span data-start="657880">In fact, what you're seeing here is Firefox 63 opening</span> <span data-start="660880">a WebP of my stupid cats.</span> <span data-start="663260">And this is in Firefox 63, which does not support WebP.</span> <span data-start="666880">WebP support doesn't land until Firefox 65.</span> </section>

<section><span data-start="669077"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="669910">But we didn't want the key features to be missing.</span> <span data-start="672560">So we needed to make sure the Squoosh could lead and create</span> <span data-start="676300">images in all modern browsers using those codecs, which</span> <span data-start="680310">brings onto — </span> <span data-start="681490">let's talk about how we built Squoosh.</span> </section>

<section><span data-start="683330"><span class="speaker">Jake Archibald</span>: Yeah, and this is</span> <span data-start="685240">an idea I had around about five years ago.</span> <span data-start="686990">It's something I'd been wanting to build.</span> <span data-start="688698">And I tried to build it five years ago,</span> <span data-start="690454">but browsers weren't quite smart enough.</span> <span data-start="692120">But more importantly, I wasn't quite smart enough.</span> <span data-start="695050">So Squoosh is a real team effort with contributions</span> <span data-start="698080">from all of these talented engineers and Paul Kinlin.</span> </section>

<section><span data-start="701548"><span class="speaker">Mariko Kosaka</span>: The key thing that made — </span> <span data-start="703214">[LAUGHTER]</span> <span data-start="705634">Are you glad that joke landed really well?</span> </section>

<section><span data-start="707930"><span class="speaker">Jake Archibald</span>: Thank you.</span> </section>

<section><span data-start="709215"><span class="speaker">Mariko Kosaka</span>: The key thing that</span> <span data-start="710590">made Squoosh possible is WebAssembly,</span> <span data-start="713320">which is supported in all modern browsers for over a year now.</span> <span data-start="717380">I know we have WebAssembly sessions later</span> <span data-start="719740">in this conference.</span> <span data-start="720860">But as a little primer, Wasm, or WebAssembly,</span> <span data-start="724630">is a compile target for the web.</span> <span data-start="727180">So you have your code written in C, Rascal, or whatever choice.</span> <span data-start="732880">You would usually compile it to run it on different OS</span> <span data-start="736570">as the app.</span> <span data-start="737410">But using WebAssembly, the technology,</span> <span data-start="740050">you can compile the same code and run it in browser.</span> <span data-start="744670">So for Squoosh, the mozjpeg, the web WebP, the OptiPNG,</span> <span data-start="748600">all of those codecs are written in C.</span> <span data-start="750760">So we used a tool called Emscripten to compile the C</span> <span data-start="754080">code into a WebAssembly so that we can run it in browser.</span> </section>

<section><span data-start="759165"><span class="speaker">Jake Archibald</span>: Yeah.</span> <span data-start="760040">And this was really, really essential for the project</span> <span data-start="761890">because browsers do actually ship</span> <span data-start="763390">with imaging coders like JPEG and PNG,</span> <span data-start="766600">which you can access via the Canvas API like this.</span> <span data-start="769340">But they suck.</span> <span data-start="770710">They are really, really bad.</span> <span data-start="772355">We have made them available in Squoosh.</span> <span data-start="773980">So you can use them if you want.</span> <span data-start="775270">They are actually quite fast.</span> <span data-start="776350">That's the one thing they've got going for them.</span> <span data-start="778420">We thought, why not?</span> <span data-start="779560">But you only get this one quality option.</span> <span data-start="781600">And ugh, they're just rubbish.</span> <span data-start="783430">This is Chrome's JPEG encoder on the left compared to mozjpeg.</span> <span data-start="787529">And it's ugh, the Chrome version is just a lot rougher.</span> <span data-start="789820">It's blah.</span> <span data-start="790382">It's horrible.</span> <span data-start="791290">It's actually way worse in Firefox.</span> </section>

<section><span data-start="793662"><span class="speaker">Mariko Kosaka</span>: Firefox.</span> </section>

<section><span data-start="794620"><span class="speaker">Jake Archibald</span>: The JPEG encoder in Mozilla's browser</span> <span data-start="797020">is terrible compared to Mozilla's JPEG encoder.</span> <span data-start="800151">[LAUGHTER]</span> </section>

<section><span data-start="802717"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="803550">We see the same thing for PNG too.</span> <span data-start="805560">So that Squoosh logo that we looked at in the demo,</span> <span data-start="808530">if you use a browser's native compressor,</span> <span data-start="812400">then those are the numbers you get.</span> <span data-start="814710">The Firefox are significantly better than other browsers.</span> <span data-start="819570">But it's still not good compared to OptiPNG, which Squoosh uses.</span> <span data-start="825720">And this is for exactly the same image, pixel-by-pixel, just</span> <span data-start="830010">compression, different numbers.</span> </section>

<section><span data-start="831570"><span class="speaker">Jake Archibald</span>: Exactly.</span> <span data-start="831990">And Wasm let's us bypass the browser's encoders</span> <span data-start="834180">and use much better ones.</span> <span data-start="835320">It also let us bring in the WebP decoder</span> <span data-start="838110">to use in browsers that don't have native WebP support.</span> <span data-start="840690">Now, I know almost nothing about C. So that part of the project</span> <span data-start="844500">was really down to this man.</span> <span data-start="846750">So please, welcome to the stage — </span> <span data-start="848400">so good, we named him once — </span> <span data-start="850290">it's Surma.</span> <span data-start="851190">[MUSIC PLAYING]</span> <span data-start="853070">[APPLAUSE]</span> </section>

<section><span data-start="858710"><span class="speaker">Mariko Kosaka</span>: So you made most of the WebAssembly stuff work.</span> </section>

<section><span data-start="863990"><span class="speaker">Surma</span>: Yeah.</span> <span data-start="865136">[LAUGHTER]</span> </section>

<section><span data-start="867630"><span class="speaker">Jake Archibald</span>: How was it?</span> </section>

<section><span data-start="868770"><span class="speaker">Surma</span>: It was good.</span> </section>

<section><span data-start="870065"><span class="speaker">Jake Archibald</span>: Cool.</span> </section>

<section><span data-start="870940"><span class="speaker">Surma</span>: Cool.</span> </section>

<section><span data-start="872987"><span class="speaker">Jake Archibald</span>: Surma, ladies and gentlemen.</span> <span data-start="874820">[MUSIC PLAYING]</span> <span data-start="875764">[APPLAUSE]</span> </section>

<section><span data-start="878457"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="879290">Well, thankfully Surma wrote an article about it.</span> <span data-start="882080">So we have some things to share.</span> </section>

<section><span data-start="883845"><span class="speaker">Jake Archibald</span>: Yeah.</span> <span data-start="884720">Compiling a codec to Wasm, that involved writing a little bit</span> <span data-start="887340">of C++, which included the codec and some of the Emscripten</span> <span data-start="890800">stuff.</span> <span data-start="891402">And then we wrote a function.</span> <span data-start="892610">This is the function we want to expose to JavaScript.</span> <span data-start="895120">It takes our image data, takes it as a string</span> <span data-start="898210">because that's how Emscripten represents binary data in C++.</span> <span data-start="901360">So on the JavaScript side, we're passing in a Uint8array.</span> <span data-start="904450">And it ends up in C++ as a string.</span> <span data-start="906790">And we also have our other arguments, width and height,</span> <span data-start="909160">and the codec settings.</span> <span data-start="910480">In this example, I'm just using quality.</span> <span data-start="913220">And then we call out to the actual encoder under the hood,</span> <span data-start="916060">passing in all the settings, getting the output,</span> <span data-start="918400">and then we return it.</span> <span data-start="919450">And this vowel and type memory view stuff,</span> <span data-start="921760">this is annotation to tell Emscripten</span> <span data-start="923680">to treat the return value as a Uint8array back in JavaScript</span> <span data-start="927130">land.</span> <span data-start="927780">And then all we needed to do is tell Emscripten</span> <span data-start="930110">which methods to expose.</span> <span data-start="931550">That's it.</span> </section>

<section><span data-start="933430"><span class="speaker">Mariko Kosaka</span>: I'm a web developer.</span> <span data-start="934900">You completely lost me.</span> <span data-start="936690">Do you get any of this?</span> </section>

<section><span data-start="938300"><span class="speaker">Jake Archibald</span>: No, I don't understand it either.</span> <span data-start="939570">But I copied the patterns from Surma's article.</span> <span data-start="941440">And hey, it just works.</span> <span data-start="942280">It's great.</span> </section>

<section><span data-start="942640"><span class="speaker">Mariko Kosaka</span>: Great.</span> </section>

<section><span data-start="943180"><span class="speaker">Jake Archibald</span>: I was able to take those patterns</span> <span data-start="944350">and use them for different kinds of C projects as well,</span> <span data-start="946300">like text compressions and stuff.</span> <span data-start="947674">It's —  yeah, it's pretty good, pretty good.</span> </section>

<section><span data-start="949910"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="950743">So compiling that code with Emscripten</span> <span data-start="953230">gives a JavaScript file in Wasm binary.</span> <span data-start="956680">So now you can include that script</span> <span data-start="959080">onto your page, which also loads that Wasm binary.</span> <span data-start="962110">And once all of the script is ready,</span> <span data-start="964180">you can just call that encoding function</span> <span data-start="966220">as if you're calling JavaScript.</span> </section>

<section><span data-start="967565"><span class="speaker">Jake Archibald</span>: Yeah.</span> <span data-start="968440">Using Emscripten, it feels a little bit rough and ready.</span> <span data-start="971650">But the docs are really good.</span> <span data-start="973090">And Surma's article is good enough to get you started.</span> </section>

<section><span data-start="975850"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="976990">But in this case, we are dealing with a large C project here.</span> <span data-start="981040">And those are really CPU intensive.</span> <span data-start="984400">So that brings us to performance,</span> <span data-start="987230">which we were kind of worried about in the beginning</span> <span data-start="990309">of the project because we knew that's going</span> <span data-start="992100">to be a thing that we need to take care.</span> </section>

<section><span data-start="993785"><span class="speaker">Jake Archibald</span>: Yeah.</span> <span data-start="994660">We're halfway through the talk, so we're actually finally</span> <span data-start="996520">starting to get to the point.</span> </section>

<section><span data-start="997940"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="998773">So we used PREACT to orchestrate the DOM</span> <span data-start="1002280">and webpack to bundle it all together.</span> </section>

<section><span data-start="1004016"><span class="speaker">Jake Archibald</span>: Yeah.</span> <span data-start="1004890">We used PREACT because it does what</span> <span data-start="1006348">it does in 3k, which is kind of amazing.</span> <span data-start="1008100">We also had Jason on the project —  that's probably — </span> </section>

<section><span data-start="1009630"><span class="speaker">Mariko Kosaka</span>: That's true.</span> <span data-start="1009954">Clear it off the [INAUDIBLE].</span> </section>

<section><span data-start="1010350"><span class="speaker">Jake Archibald</span>:  — another reason.</span> <span data-start="1010910">We wouldn't want to upset him.</span> <span data-start="1012210">And we used webpack because there isn't really anything</span> <span data-start="1014501">else that does what webpack does, certainly, not</span> <span data-start="1016710">in the way we wanted it done.</span> <span data-start="1017918">We wanted a lot of control over it.</span> <span data-start="1019860">And it was really only webpack.</span> </section>

<section><span data-start="1021797"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="1022630">So as a result, our app is 400 Kilobyte gzipped,</span> <span data-start="1028650">all in all, everything.</span> <span data-start="1031290">But this is well below the median</span> <span data-start="1034020">from HTTP Archive, which is 1.5 megabytes.</span> <span data-start="1038020">So we're quite happy about that.</span> </section>

<section><span data-start="1039655"><span class="speaker">Jake Archibald</span>: Yeah.</span> <span data-start="1040530">We're winning.</span> <span data-start="1040800">We're winning.</span> <span data-start="1041383">We're happy with that.</span> <span data-start="1043880">So the vast majority of that size</span> <span data-start="1045579">is the codecs and the processes, like,</span> <span data-start="1047530">the stuff we brought in from C land.</span> <span data-start="1049249">And that's —  yeah — </span> <span data-start="1050040">300 kilobytes of that stuff.</span> <span data-start="1051780">And I'm pretty sure there's some waste and duplication here.</span> <span data-start="1054280">But like I said, Emscripten's a little bit rough and ready.</span> <span data-start="1057130">And cosharing between Wasm modules,</span> <span data-start="1058850">it doesn't seem all that easy right now.</span> <span data-start="1060970">It's something we'll look into.</span> <span data-start="1062360">But we were able to limit that damage by lazy-loading</span> <span data-start="1065140">these using workers.</span> </section>

<section><span data-start="1066510"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="1067343">As we've already seen, compressor is CPU intensive.</span> <span data-start="1070690">So depending on settings, encoding</span> <span data-start="1073000">can take 30 seconds to sometimes minutes.</span> <span data-start="1076450">And when that thing is happening and occupying CPU,</span> <span data-start="1079710">we don't want that UI to be frozen.</span> <span data-start="1081850">We want users to be pinch zooming,</span> <span data-start="1083710">and moving around, and testing, and possibly changing</span> <span data-start="1086440">the options too.</span> <span data-start="1088771">So — </span> </section>

<section><span data-start="1089270"><span class="speaker">Jake Archibald</span>: Yeah.</span> <span data-start="1089570">Workers give us this lazy loading stuff</span> <span data-start="1091194">for free, which is great.</span> <span data-start="1092330">But the main benefit is concurrency.</span> <span data-start="1094390">We create up to two workers.</span> <span data-start="1096437">And both of those are just going to be</span> <span data-start="1098020">pointing at the same script.</span> <span data-start="1099186">That's one for the left-hand side of the image</span> <span data-start="1101170">and one for the right-hand side of the image.</span> <span data-start="1103130">This means the left-hand side can be encoding a JPEG.</span> <span data-start="1106540">And the right-hand side can be optimizing PNG.</span> <span data-start="1108910">And all the while, the main thread stays responsive.</span> <span data-start="1111299">And that was really all the concurrency that we needed.</span> </section>

<section><span data-start="1113590"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="1114423">But it came with another benefit too.</span> <span data-start="1117552">So the left-hand side —  let's say [INAUDIBLE],,</span> <span data-start="1119510">left-hand side worker is compressing an image, right?</span> <span data-start="1122500">But what if a user changes the setting?</span> <span data-start="1124720">The current job is out of date.</span> <span data-start="1126910">We need to update it.</span> <span data-start="1128510">But those compression encoders are</span> <span data-start="1132722">written in a synchronous way.</span> <span data-start="1133930">So there is no abort API.</span> <span data-start="1135330">There is no way to kill it.</span> <span data-start="1136540">However, we put it into worker.</span> <span data-start="1139690">So in this case, we just terminate the worker,</span> <span data-start="1142760">and then click new workers, put the new job in, and then start</span> <span data-start="1145740">it back up again.</span> </section>

<section><span data-start="1146705"><span class="speaker">Jake Archibald</span>: Yeah.</span> <span data-start="1147580">And the implementation for this is pretty simple.</span> <span data-start="1151392">So it's just like this.</span> </section>

<section><span data-start="1152350"><span class="speaker">Mariko Kosaka</span>: Ooh.</span> </section>

<section><span data-start="1152690"><span class="speaker">Jake Archibald</span>: Oh.</span> <span data-start="1153481">Oh, go on, you click.</span> <span data-start="1155087">This is the problem.</span> <span data-start="1155920">We've got two slide clickers.</span> <span data-start="1157240">And we needed to rehearse who was doing</span> <span data-start="1159040">the changing for each slide.</span> <span data-start="1160910">So what you saw there was us messing it up.</span> <span data-start="1163000">[LAUGHTER]</span> <span data-start="1165400">Implementation is roughly like this — </span> <span data-start="1167420">if busy, terminate, and restart.</span> <span data-start="1169480">But also, we only spin up one of these workers when we need it,</span> <span data-start="1172350">like, just in time.</span> <span data-start="1173440">So if you're doing something kind of like what we were doing</span> <span data-start="1175510">in the demo —  we had the original image on one side,</span> <span data-start="1177676">JPEG on the other.</span> <span data-start="1178510">We only spin up one worker because we're only</span> <span data-start="1180384">having one side doing compression at the time.</span> <span data-start="1182810">And also, if one of those workers is idle for 10 seconds,</span> <span data-start="1186340">we kill it as well.</span> <span data-start="1187310">And that is really just to be kind to the user's device</span> <span data-start="1189730">to bring the memory footprint down.</span> </section>

<section><span data-start="1191050"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="1191883">That worker is almost empty when it started.</span> <span data-start="1194750">Heavy stuff is imported when it's needed.</span> <span data-start="1198040">This keeps the worker startup time down.</span> <span data-start="1200560">And also, you don't really need to download and parse and wait</span> <span data-start="1204160">for the OptiPNG and mozjpeg stuff</span> <span data-start="1206890">if user is just encoding WebP.</span> </section>

<section><span data-start="1209135"><span class="speaker">Jake Archibald</span>: Yeah.</span> <span data-start="1210010">And using a wait import like this,</span> <span data-start="1212380">this is part of the platform.</span> <span data-start="1213920">It's supported behind a flag in Chrome.</span> <span data-start="1215770">But it isn't supported and stable or in other browsers.</span> <span data-start="1218237">Thankfully, it's something that webpack can just handle.</span> <span data-start="1220570">It polyfills it, and it just works.</span> <span data-start="1222990">Now, the final piece of this puzzle</span> <span data-start="1224950">is how we actually talk to the workers.</span> </section>

<section><span data-start="1226727"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="1227560">So request and response communication with workers — </span> <span data-start="1230810">eh, a little tricky.</span> <span data-start="1232430">So the way worker works is that you send the worker some job.</span> <span data-start="1236350">And at some point, they come back with the results.</span> <span data-start="1239780">But you need to associate those requests and response.</span> <span data-start="1242360">So in this code example, we just give a unique ID.</span> <span data-start="1245800">And when worker is done with that job,</span> <span data-start="1248270">then it gives back the ID.</span> <span data-start="1249610">But you have to write your own logic for this.</span> <span data-start="1253240">And it's like, eh, eh, eh.</span> </section>

<section><span data-start="1255062"><span class="speaker">Jake Archibald</span>: It's rubbish.</span> <span data-start="1256270">I really don't like it.</span> <span data-start="1257020">It's one of the things that puts me off putting stuff</span> <span data-start="1259272">into the —  of a thread.</span> <span data-start="1260230">It goes ah, I'm going to have to do the post method thing.</span> <span data-start="1262330">I don't like it.</span> </section>

<section><span data-start="1262710"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="1262900">That's a layer to worry about when</span> <span data-start="1264840">you're writing application.</span> </section>

<section><span data-start="1266170"><span class="speaker">Jake Archibald</span>: But again, to the rescue, it's Surma.</span> <span data-start="1269140">[LAUGHTER]</span> <span data-start="1270310">He built Comlink, a little library that you can use,</span> <span data-start="1272830">you can get from mPm to use it.</span> <span data-start="1274420">It's just like this.</span> <span data-start="1275260">You create a worker as you usually would.</span> <span data-start="1277180">And then you tell Comlink all of the things</span> <span data-start="1278620">that you want to expose.</span> <span data-start="1279700">These can be classes, values.</span> <span data-start="1281590">But we were just using functions.</span> <span data-start="1283230">And then over in your page, you just hook the Comlink up</span> <span data-start="1286360">to the worker.</span> <span data-start="1287140">And now you can call those functions just as</span> <span data-start="1289270">if they're part of your page.</span> <span data-start="1290487">Comlink takes care of all of the bookkeeping, the post message</span> <span data-start="1293070">stuff, all of that mess.</span> </section>

<section><span data-start="1294880"><span class="speaker">Mariko Kosaka</span>: So once we've split up that codecs,</span> <span data-start="1297460">our app came down to 35 kilobyte.</span> <span data-start="1301340">Yeah.</span> <span data-start="1302350">But I want to make sure that a user will still</span> <span data-start="1304660">have to download those 300 kilobytes if they</span> <span data-start="1307900">want to use all of the codecs.</span> <span data-start="1309430">But they don't need to load those upfront.</span> <span data-start="1314010">But 35 kilobytes, it still contains the pinch zoom logic,</span> <span data-start="1319950">the options panel, the fancy slider, then this thing,</span> <span data-start="1323485">and that thing, this thing, this thing, ooh, that thing too.</span> <span data-start="1327270">And what these have in common is that it's not</span> <span data-start="1333210">here, our first page.</span> </section>

<section><span data-start="1336085"><span class="speaker">Jake Archibald</span>: Yeah.</span> <span data-start="1336960">Imagine going to a restaurant and asking to see the menu.</span> <span data-start="1339900">And 10 minutes later, you still haven't been given it.</span> <span data-start="1342750">So you're going to ask, excuse me, where's the menu?</span> <span data-start="1345630">And they say, oh, well, we're busy preparing</span> <span data-start="1348240">every single dish we do.</span> <span data-start="1350190">And then we'll give you the menu,</span> <span data-start="1352380">so when you pick something —  bam — </span> <span data-start="1353960">we will give you that straight away.</span> <span data-start="1355570">It's ready.</span> <span data-start="1356660">[LAUGHTER]</span> </section>

<section><span data-start="1357420"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="1358253">You laugh but much of the web is built this way, especially</span> <span data-start="1362250">JavaScript-heavy apps.</span> </section>

<section><span data-start="1363360"><span class="speaker">Jake Archibald</span>: Yeah.</span> <span data-start="1363540">Because you might look at the menu and decide,</span> <span data-start="1365456">oh, I don't want any of this stuff.</span> <span data-start="1367590">Or you might want something simple.</span> <span data-start="1369120">You're certainly unlikely to want everything.</span> <span data-start="1371190">So why should getting the menu and making a choice be blocked</span> <span data-start="1374040">on them preparing all of their most</span> <span data-start="1375930">complex, time-consuming dishes?</span> </section>

<section><span data-start="1377677"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="1378510">Same for JavaScript apps.</span> <span data-start="1379680">They prepare everything up front before doing anything.</span> <span data-start="1383820">So the user really shouldn't have</span> <span data-start="1385800">to wait for all of these things to download, parse,</span> <span data-start="1389190">and execute.</span> <span data-start="1390690">They just need to get to this page.</span> </section>

<section><span data-start="1392445"><span class="speaker">Jake Archibald</span>: And like most web apps —  like most apps — </span> <span data-start="1394820">Squoosh has a limited set of first interactions.</span> <span data-start="1397580">[INAUDIBLE] it's dropping an image onto the page,</span> <span data-start="1400020">selecting one file by the file picker,</span> <span data-start="1402090">or selecting one of the demo images.</span> <span data-start="1404050">So we split all of that out.</span> <span data-start="1406290">This is roughly how things looked at the start.</span> <span data-start="1408330">We had our intro.</span> <span data-start="1409050">And we had our compression UI.</span> <span data-start="1410850">If no file had been selected, we show the intro.</span> <span data-start="1412997">Otherwise, we send that file to the compression UI</span> <span data-start="1415080">and display that.</span> <span data-start="1416580">We changed this so the whole compression API part,</span> <span data-start="1419340">that was loaded asynchronously.</span> <span data-start="1420900">And the tool chain actually made that</span> <span data-start="1422692">a lot easier than I expected.</span> </section>

<section><span data-start="1423900"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="1424733">So first up, we removed the URL import</span> <span data-start="1427590">and instead, dynamically imported</span> <span data-start="1429720">that in the constructor and set that as a state.</span> <span data-start="1432950">So dynamic imports are supported natively in Chrome and Safari.</span> <span data-start="1437160">But using webpack provides similar functionality</span> <span data-start="1440190">to all of the browsers.</span> </section>

<section><span data-start="1441660"><span class="speaker">Jake Archibald</span>: Yeah.</span> <span data-start="1441870">So the compression UI is going to start downloading</span> <span data-start="1444090">as soon as the intro loads.</span> <span data-start="1445950">But there is a small chance that the user</span> <span data-start="1447720">is going to be able to select a file before it's ready.</span> <span data-start="1450880">So in which case, we just show a spinner.</span> <span data-start="1452700">Very unlikely that the user is going to see that,</span> <span data-start="1454741">but we put that in just in case.</span> </section>

<section><span data-start="1456507"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="1457340">So remember with codec, speed it up.</span> <span data-start="1460640">We chopped that 300 kilobytes off.</span> <span data-start="1462550">But with the code splitting, we made that into 15 kilobytes.</span> <span data-start="1469330">And this is despite our app being JavaScript-driven,</span> <span data-start="1473230">using frameworks.</span> <span data-start="1474700">And 15 kilobyte gzipped is even with empty cache</span> <span data-start="1478000">on the user's device.</span> </section>

<section><span data-start="1478930"><span class="speaker">Jake Archibald</span>: Exactly.</span> <span data-start="1479930">And that means on a slow 3G connection,</span> <span data-start="1482260">the user gets the first interaction in 3.3 seconds.</span> <span data-start="1484960">And that's a slow connection on a slow phone,</span> <span data-start="1488060">but it's not the worst conditions.</span> <span data-start="1491110">Even on 2G, we are still interactive</span> <span data-start="1493990">in less than 5 seconds.</span> <span data-start="1495679">Now, I don't think many people in this room</span> <span data-start="1497470">spend a lot of time on 2G.</span> <span data-start="1498640">I know I don't.</span> <span data-start="1499714">But this kind of performance means</span> <span data-start="1501130">the app is really usable even in emerging markets.</span> <span data-start="1504160">And this is why I'm a huge fan of</span> <span data-start="1505780">these microframeworks, like PREACT,</span> <span data-start="1507440">but also Lit-html, hyperHTML, Svelte.</span> <span data-start="1510820">We couldn't have actually hit these numbers with React</span> <span data-start="1513340">because that's 30, 40 kilobytes out the door.</span> <span data-start="1515770">We couldn't do it with Vue, because that's 20 kilobytes.</span> <span data-start="1518310">Angular is 60.</span> <span data-start="1519220">Ember is bigger still.</span> <span data-start="1520360">But let's not get carried away.</span> <span data-start="1522990">15 kilobytes, 8 of which is JavaScript,</span> <span data-start="1526300">is actually a lot of JavaScript for these couple</span> <span data-start="1529990">of interactions.</span> </section>

<section><span data-start="1530687"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="1531520">So for instance, let's look at how</span> <span data-start="1533650">we might build this user interface with just Vanilla</span> <span data-start="1537760">JavaScript.</span> <span data-start="1539110">So here's a minimal implementation</span> <span data-start="1541330">of drag and drop, just a few lines.</span> <span data-start="1543940">And then add that to that drag and drop</span> <span data-start="1546540">is the self-selecting of file code.</span> <span data-start="1549640">That's not that much.</span> <span data-start="1551140">And then this is for selecting one of the demos,</span> <span data-start="1553870">clicking, and loading the image.</span> <span data-start="1555290">So these, all of that code, minified and gzipped,</span> <span data-start="1560020">it's only 550 bytes.</span> </section>

<section><span data-start="1562502"><span class="speaker">Jake Archibald</span>: Or 350 bytes.</span> </section>

<section><span data-start="1563710"><span class="speaker">Mariko Kosaka</span>: Ooh.</span> </section>

<section><span data-start="1564020"><span class="speaker">Jake Archibald</span>: But whatever.</span> <span data-start="1564790">I'll go with the number on the screen.</span> </section>

<section><span data-start="1565900"><span class="speaker">Mariko Kosaka</span>: Can't see the number.</span> <span data-start="1567400">Yes, 350 bytes.</span> </section>

<section><span data-start="1569987"><span class="speaker">Jake Archibald</span>: And that's why I get really,</span> <span data-start="1571820">really grumpy when I see sites like with this 600k or more</span> <span data-start="1575320">JavaScript bundle.</span> <span data-start="1576290">And that's for first interaction.</span> <span data-start="1577859">I have friends who build native apps.</span> <span data-start="1579400">And when they talk about their two megabyte Android Instant</span> <span data-start="1581858">Apps, I love being able to go, instant, 2 megabytes.</span> <span data-start="1584410">Great.</span> <span data-start="1584920">15k.</span> <span data-start="1586158">[LAUGHTER]</span> <span data-start="1587115">But then they — </span> </section>

<section><span data-start="1587740"><span class="speaker">Mariko Kosaka</span>: With your smug face on.</span> </section>

<section><span data-start="1589020"><span class="speaker">Jake Archibald</span>: Yeah.</span> <span data-start="1589894">[CHUCKLE]</span> <span data-start="1591035">I think it's called a shit-eating grin.</span> <span data-start="1592660">Anyway.</span> <span data-start="1593160">[LAUGHTER]</span> <span data-start="1594040">But then they can point to large parts</span> <span data-start="1595960">of the web that have thrown this advantage away.</span> <span data-start="1599920">Parts of the website have taken on the worst of native</span> <span data-start="1602590">but none of the benefits.</span> </section>

<section><span data-start="1604200"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="1605033">So if you take anything, anything out of this</span> <span data-start="1607810">talk, please, please, please, study your website or your web</span> <span data-start="1611440">apps, and find out what the first interaction is.</span> <span data-start="1614710">And shift the reasonable amount of code</span> <span data-start="1617140">for that first interaction.</span> <span data-start="1618740">Now, reasonable amount of code.</span> <span data-start="1620210">How do we find out?</span> <span data-start="1621220">We have a lot of tools.</span> <span data-start="1622550">Yeah.</span> <span data-start="1623050">Just experiment, and find out what is reasonable to you.</span> </section>

<section><span data-start="1628562"><span class="speaker">Jake Archibald</span>: So you also need to keep an eye</span> <span data-start="1630520">on the bundles between builds.</span> <span data-start="1632830">And with webpack —  and right now that,</span> <span data-start="1634510">unfortunately, means going and looking at minified code.</span> <span data-start="1637012">Because that's where it does things</span> <span data-start="1638470">like tree-shaking and dead-code removal.</span> <span data-start="1640090">It's part of the minification process.</span> </section>

<section><span data-start="1641190"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="1641350">We ran into a few bugs because of that, right?</span> </section>

<section><span data-start="1643267"><span class="speaker">Jake Archibald</span>: Yeah.</span> <span data-start="1644141">We were still not quite sure if it was a bug in webpack</span> <span data-start="1646530">or if it was our expectations were different to what webpack</span> <span data-start="1649030">was doing.</span> <span data-start="1649570">But it was when we dived into the minified bundle, that's</span> <span data-start="1651945">when we found that stuff out.</span> <span data-start="1653170">Alternatives, like rollup are much better here.</span> <span data-start="1656120">They will show you the dead-code removal during development.</span> <span data-start="1658640">So it's easier to see when something's not</span> <span data-start="1660390">going as you expect.</span> <span data-start="1661340">But rollup doesn't have the kind of holistic asset graph</span> <span data-start="1663760">that we really needed for this project.</span> <span data-start="1665500">Anyway, my point is, there are huge gains</span> <span data-start="1667510">to be had by keeping an eye on this stuff.</span> </section>

<section><span data-start="1669387"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="1670220">So like we said, we used PREACT to orchestrate the DOM</span> <span data-start="1673900">But we also used Web Components When</span> <span data-start="1677800">we were building this system, we were</span> <span data-start="1679414">talking to a lot of developers of,</span> <span data-start="1680830">yeah, we are building this cool app.</span> <span data-start="1682780">And we were using PREACT.</span> <span data-start="1683881">And you're going to be — </span> <span data-start="1684880">got Web Components.</span> <span data-start="1685990">And they were kind of surprised.</span> <span data-start="1688000">Because they were asking questions like, well, wait.</span> <span data-start="1690400">Isn't Web Components an alternative to frameworks?</span> </section>

<section><span data-start="1692507"><span class="speaker">Jake Archibald</span>: Yeah, but they're not.</span> <span data-start="1694090">I don't know why you would think that.</span> <span data-start="1695410">Well, actually, I don't know why you would think that,</span> <span data-start="1696980">and I think it's our fault. Well,</span> <span data-start="1698355">I think it's Google's fault. I think</span> <span data-start="1700112">our messaging suggested that Web Components are</span> <span data-start="1702070">the same thing as Polymer.</span> <span data-start="1703750">And Polymer is an alternative to the frameworks.</span> <span data-start="1706150">But web-components, they're not the same thing.</span> <span data-start="1708370">Web Components are the lower level</span> <span data-start="1710050">primitive that Polymer uses.</span> </section>

<section><span data-start="1711257"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="1712090">We did use Polymer's custom element polyfill for Edge.</span> <span data-start="1716070">But for other browsers, we just shipped the Vanilla web</span> <span data-start="1719010">components</span> </section>

<section><span data-start="1720035"><span class="speaker">Jake Archibald</span>: Yeah.</span> <span data-start="1720910">We used custom elements for some of our leaf components</span> <span data-start="1723201">that contained the minimal amount of state.</span> <span data-start="1725696">For instance, this is the pinch-zoom element.</span> <span data-start="1727570">Just put stuff inside it; now you can pinch-zoom it.</span> <span data-start="1730040">And it has an API.</span> <span data-start="1731570">We also did this with our side-by-side slidy thing,</span> <span data-start="1734800">comparison.</span> </section>

<section><span data-start="1735370"><span class="speaker">Mariko Kosaka</span>: We call it two-up.</span> </section>

<section><span data-start="1736240"><span class="speaker">Jake Archibald</span>: We call it a two-up, yeah,</span> <span data-start="1737530">because we didn't know what else to call it.</span> <span data-start="1738760">A fancy range input, drop target — </span> <span data-start="1740560">we made components for all these bits and pieces.</span> </section>

<section><span data-start="1742780"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="1743613">So we could have done all of this in PREACT component</span> <span data-start="1746260">because we were using PREACT.</span> <span data-start="1747700">But using Web Components, we can take that</span> <span data-start="1750970">and put it into some other project using</span> <span data-start="1753220">different frameworks or just use it as is in the project</span> <span data-start="1757210">that you don't really need framework.</span> </section>

<section><span data-start="1758950"><span class="speaker">Jake Archibald</span>: Yeah.</span> <span data-start="1759130">And if you're open sourcing client,</span> <span data-start="1760150">Web Components are the best way to share things</span> <span data-start="1762108">like this, so we did.</span> <span data-start="1763627">We have released a few of our Web Components</span> <span data-start="1765460">a separate project.</span> <span data-start="1766280">So we'll make more available as we extract them</span> <span data-start="1768340">from the main app.</span> <span data-start="1769539">We were hoping to release more.</span> <span data-start="1770830">But uh, we've run out of Time — </span> <span data-start="1772121">Whatever.</span> <span data-start="1772870">We used PREACT, but these things,</span> <span data-start="1774550">they can be used in Vue, Svelte, Angular, React, whatever.</span> </section>

<section><span data-start="1777737"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="1778570">Most frameworks are fine with Web Component.</span> <span data-start="1781540">But some have a few rough edges.</span> <span data-start="1784220">So if you are curious, check out custom-elements-everywhere.com</span> <span data-start="1787735">to see how custom elements work with whatever the framework you</span> <span data-start="1791630">are using.</span> </section>

<section><span data-start="1793300"><span class="speaker">Jake Archibald</span>: We also released libraries</span> <span data-start="1795050">for some of the other things we built,</span> <span data-start="1796310">like a pointer event helper, thing,</span> <span data-start="1797894">and a webpack plugin for dealing with asset inlining</span> <span data-start="1800060">and optimization.</span> <span data-start="1801260">So it has been — </span> <span data-start="1803240">well, we're vastly running out of time — </span> <span data-start="1805100">20-odd minutes, and I haven't yet mentioned service workers.</span> </section>

<section><span data-start="1809450"><span class="speaker">Mariko Kosaka</span>: A new record at the very end, very end.</span> </section>

<section><span data-start="1811910"><span class="speaker">Jake Archibald</span>: New personal record.</span> <span data-start="1813547">Yes, the site does work offline.</span> <span data-start="1814880">Our service worker approach isn't particularly novel.</span> <span data-start="1816890">We catch the things.</span> <span data-start="1817700">We serve the things.</span> <span data-start="1818450">That means it works offline.</span> <span data-start="1819430">And we also let the user know when</span> <span data-start="1820850">there's an update available.</span> </section>

<section><span data-start="1822420"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="1823253">But there's one unique thing about this Squoosh.</span> <span data-start="1827900">That is, when users first visit the site, we cache all of it</span> <span data-start="1832190">in the next interaction.</span> <span data-start="1833750">But we do not cache any of the codec, the 300 kilobyte bit,</span> <span data-start="1838550">until the user access will drop the image</span> <span data-start="1841400">and then get to this view.</span> </section>

<section><span data-start="1842820"><span class="speaker">Jake Archibald</span>: Yeah.</span> <span data-start="1842960">And this was just being kind to the user's bandwidth.</span> <span data-start="1845000">When the user just visits the site,</span> <span data-start="1846458">it feels rude to download the whole 400k app.</span> <span data-start="1849124">So we wait for some signal from the user</span> <span data-start="1850790">that they're actually interested.</span> <span data-start="1852260">And that's when we cache the chunkier parts.</span> </section>

<section><span data-start="1854210"><span class="speaker">Mariko Kosaka</span>: Yeah.</span> <span data-start="1855043">And this is what we love about the web, right?</span> <span data-start="1857090">Write it once, build it, and then put it</span> <span data-start="1859400">into phone, tablet, desktop, with the fraction of the size.</span> </section>

<section><span data-start="1865415"><span class="speaker">Jake Archibald</span>: Of the equivalent native app, yeah.</span> <span data-start="1867540">And those native apps are only targeting one operating system.</span> <span data-start="1870320">Whereas, we can hit loads of them.</span> <span data-start="1871760">And to share it, just copy the URL — </span> </section>

<section><span data-start="1873710"><span class="speaker">Mariko Kosaka</span>: That's the best part.</span> </section>

<section><span data-start="1874430"><span class="speaker">Jake Archibald</span>:  — and send it to someone.</span> </section>

<section><span data-start="1874730"><span class="speaker">Mariko Kosaka</span>: That's the best part of the web.</span> </section>

<section><span data-start="1875720"><span class="speaker">Jake Archibald</span>: Love it.</span> </section>

<section><span data-start="1876720"><span class="speaker">Mariko Kosaka</span>: So if you want to dig into the code,</span> <span data-start="1879120">it's all on GitHub.</span> <span data-start="1880610">There are lots of things we want to do.</span> <span data-start="1883100">There are bugs to fix, codecs we want to include.</span> <span data-start="1886610">And if you're interested, please come join us to build this up.</span> <span data-start="1890020">We really want this tool to be really useful to everyone.</span> </section>

<section><span data-start="1893047"><span class="speaker">Jake Archibald</span>: Yes, absolutely.</span> <span data-start="1894380">So thanks for listening.</span> <span data-start="1896090">Now go Squoosh some images.</span> </section>

<section><span data-start="1898469"><span class="speaker">Mariko Kosaka</span>: Please never say that again.</span> <span data-start="1900260">[APPLAUSE]</span> <span data-start="1901160">Thank you very much.</span> </section>

<section><span data-start="1902153"><span class="speaker">Jake Archibald</span>: I promise nothing.</span> <span data-start="1902340">Thank you very much.</span> <span data-start="1903530">[MUSIC PLAYING]</span> </section>

</div>

<script>
/*eslint-disable */
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'en',
    layout: google.translate.TranslateElement.InlineLayout.SIMPLE
    },
    'google_translate_element');
}
/* eslint-enable */
</script>

  <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

  <script src="https://www.youtube.com/iframe_api"></script>
</body>

</html>
